<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Inventario - Stockeando</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="modern-theme.css">
    <link rel="stylesheet" href="mobile-enhancements.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
            padding: var(--space-5);
            transition: all var(--transition-base);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            animation: slideIn 0.6s ease-out;
        }
        .main-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            box-shadow: 0 2px 10px rgba(31, 41, 55, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .main-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 20px;
            gap: 8px;
            flex-wrap: wrap;
        }
        .nav-link {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 500;
            font-size: 0.95em;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
        }
        .nav-logo {
            font-weight: 700;
            font-size: 1.1em;
        }
        .main-footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        .footer-link {
            color: #666;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .footer-link:hover {
            color: var(--secondary-700);
        }
        .header {
            background: linear-gradient(135deg, #374151, #4b5563);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .content {
            padding: 40px;
        }
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }
        .left-sections {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .right-content {
            min-height: 400px;
        }
        .section-card {
            background: linear-gradient(135deg, var(--secondary-50), var(--secondary-100));
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 3px solid transparent;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .section-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }
        
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left var(--transition-base);
        }
        
        .section-card:hover::before {
            left: 100%;
        }
        .section-card.active {
            border-color: var(--primary-400);
            background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
            box-shadow: 0 0 0 4px var(--primary-100);
        }
        .section-icon {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
            color: #333;
        }
        .section-status {
            color: #666;
            font-size: 0.85em;
        }
        .categories-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .category-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .category-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .category-item-icon {
            font-size: 1.2em;
            margin-bottom: 6px;
        }
        .category-item-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        .category-count {
            background: #2196f3;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75em;
            font-weight: bold;
            margin-top: 5px;
            display: inline-block;
        }
        .category-detail {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .category-detail.show {
            display: block;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .product-item-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            text-align: center;
            box-shadow: var(--shadow-md);
            font-size: var(--text-sm);
            transition: all var(--transition-fast);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .product-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left var(--transition-fast);
        }
        
        .product-item-card:hover::before {
            left: 100%;
        }
        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .product-measure {
            color: #666;
            font-size: 0.9em;
        }
        .product-lot, .product-code {
            color: #888;
            font-size: 0.8em;
            margin-top: 2px;
        }
        .product-item-card[draggable="true"] {
            cursor: grab;
            transition: all 0.3s ease;
        }
        .product-item-card[draggable="true"]:hover {
            transform: scale(1.05) rotate(2deg);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }
        .product-item-card[draggable="true"]:active {
            cursor: grabbing;
        }
        .section-card.drag-over,
        .plant-card.drag-over {
            border: 3px solid var(--primary-400);
            background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
            transform: scale(1.05);
            box-shadow: 0 0 20px var(--primary-200);
            animation: pulse 1s infinite;
        }
        .plants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 30px 0 40px 0;
        }
        .plant-card {
            background: linear-gradient(135deg, var(--secondary-50), var(--secondary-100));
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }
        .plant-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: var(--shadow-xl);
        }
        
        .plant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left var(--transition-base);
        }
        
        .plant-card:hover::before {
            left: 100%;
        }
        .plant-card.active {
            border-color: var(--success-500);
            background: linear-gradient(135deg, var(--success-50), #c8e6c9);
            box-shadow: 0 0 0 4px var(--success-50);
        }
        .plant-icon {
            font-size: 2.8em;
            margin-bottom: 15px;
        }
        .plant-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }
        .plant-status {
            color: #666;
            font-size: 0.9em;
        }
        .plant-detail {
            display: none;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }
        .plant-detail.show {
            display: block;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .detail-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .detail-icon {
            font-size: 2em;
            margin-bottom: 12px;
        }
        .detail-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        .detail-info {
            color: #666;
            font-size: 0.9em;
        }
        .machines-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .plant2-layout {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .deposit-card {
            height: fit-content;
        }
        .materials-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .material-item {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            cursor: grab;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        .material-item:hover {
            background: #bbdefb;
            transform: translateX(5px);
        }
        .material-item:active {
            cursor: grabbing;
        }
        .machines-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .machine-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 300px;
        }
        .machine-materials {
            margin-top: 15px;
            min-height: 200px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .drop-zone {
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        .machine-material {
            background: #c8e6c9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.85em;
            cursor: grab;
            transition: all 0.3s ease;
        }
        .machine-material:hover {
            background: #a5d6a7;
            transform: translateX(-5px);
        }
        .machine-material:active {
            cursor: grabbing;
        }
        .deposit-card.drag-over {
            border: 3px solid var(--primary-400);
            background: var(--primary-50);
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--primary-200);
        }
        .rejected-section {
            display: flex;
            flex-direction: column;
        }
        .rejected-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 300px;
        }
        .rejected-materials {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px dashed #f44336;
            border-radius: 8px;
            padding: 15px;
        }
        .rejected-material {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.85em;
        }
        .rejected-card.drag-over {
            border: 3px solid var(--error-500);
            background: var(--error-50);
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--error-200);
        }
        .rejection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .modal-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .modal-btn.cancel {
            background: #666;
        }
        .machine-card.drag-over {
            border: 3px solid var(--success-500);
            background: var(--success-50);
            transform: scale(1.02);
            box-shadow: 0 0 15px var(--success-200);
        }
        .request-btn, .add-btn, .enter-btn {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-xs);
            margin-top: var(--space-2);
            transition: all var(--transition-fast);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .request-btn::before, .add-btn::before, .enter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left var(--transition-fast);
        }
        
        .request-btn:hover::before, .add-btn:hover::before, .enter-btn:hover::before {
            left: 100%;
        }
        .request-btn:hover, .add-btn:hover {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .enter-btn {
            background: linear-gradient(135deg, var(--success-500), var(--success-600));
        }
        .enter-btn:hover {
            background: linear-gradient(135deg, var(--success-600), #2d7738);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .delete-btn {
            background: linear-gradient(135deg, var(--error-500), var(--error-600));
            color: white;
            border: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-xs);
            transition: all var(--transition-fast);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .delete-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left var(--transition-fast);
        }
        
        .delete-btn:hover::before {
            left: 100%;
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, var(--error-600), #b91c1c);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .product-requested {
            background: var(--warning-50) !important;
            border: 2px solid var(--warning-500);
            animation: pulse 2s infinite;
        }
        .product-in-transit {
            background: var(--success-50) !important;
            border: 2px solid var(--success-500);
            position: relative;
        }
        
        .product-in-transit::after {
            content: 'üöö';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px var(--primary-300); }
            50% { box-shadow: 0 0 20px var(--primary-400), 0 0 30px var(--primary-300); }
        }
        
        .dragging {
            opacity: 0.5 !important;
            transform: rotate(5deg) scale(0.95) !important;
            transition: all var(--transition-fast);
        }
        
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .success-glow {
            animation: glow 1s ease-in-out;
        }
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .products-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            color: #333;
        }
        .products-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .products-table tr:hover {
            background: #f9f9f9;
        }
        .category-filter {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            font-size: 0.9em;
            margin-right: 10px;
        }
        .product-quantity {
            color: #2196f3;
            font-weight: 600;
            font-size: 0.85em;
            margin-top: 3px;
        }
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .plants-grid {
                grid-template-columns: 1fr;
            }
            .machines-grid {
                grid-template-columns: 1fr;
            }
            .plant2-layout {
                grid-template-columns: 1fr;
            }
            .rejected-section {
                order: 3;
            }
            .machines-section {
                grid-template-columns: 1fr;
            }
            .request-btn, .add-btn, .enter-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }
            .products-table {
                font-size: 0.85em;
            }
            .products-table th, .products-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <nav class="main-nav">
                <a href="stockeando.html" class="nav-link nav-logo">Stockeando</a>
                <a href="productos.html" class="nav-link">Productos</a>
                <a href="inventario.html" class="nav-link active">Inventario</a>
                <a href="movimientos.html" class="nav-link">Movimientos</a>

                <a href="reportes.html" class="nav-link">Reportes</a>
                <a href="#eliminados" class="nav-link" onclick="toggleSection('eliminados')">Eliminados/Rechazados</a>
            </nav>
        </header>
        
        <div class="header">
            <h1>üè≠ Control de Inventario</h1>
            <p>Gesti√≥n visual de plantas y dep√≥sitos</p>
            <button onclick="resetPlantStock()" class="btn-modern delete-btn" style="margin-top: var(--space-3);">
                üîÑ Reiniciar Stock de Plantas
            </button>
        </div>
        
        <div class="content">
            <div class="main-layout">
                <div class="left-sections">
                    <div class="section-card" onclick="toggleSection('pedidos')" 
                         ondrop="dropToSection(event, 'pedidos')" ondragover="allowDrop(event)">
                        <div class="section-icon">üìã</div>
                        <div class="section-title">Pedidos</div>
                        <div class="section-status">Pendientes</div>
                    </div>
                    
                    <div class="section-card" onclick="toggleSection('transito')" 
                         ondrop="dropToSection(event, 'transito')" ondragover="allowDrop(event)">
                        <div class="section-icon">üöö</div>
                        <div class="section-title">Tr√°nsito</div>
                        <div class="section-status">Env√≠os activos</div>
                    </div>
                    
                    <div class="section-card" onclick="toggleSection('deposito')" 
                         ondrop="dropToSection(event, 'deposito')" ondragover="allowDrop(event)">
                        <div class="section-icon">üè¢</div>
                        <div class="section-title">Dep√≥sito General</div>
                        <div class="section-status">Stock central</div>
                    </div>
                    
                    <div class="section-card" onclick="toggleSection('eliminados')">
                        <div class="section-icon">üóëÔ∏è</div>
                        <div class="section-title">Eliminados/Rechazados</div>
                        <div class="section-status">Productos eliminados y rechazados</div>
                    </div>
                </div>
                
                <div class="right-content">
                    <!-- Detalle de secciones superiores -->
                    <div id="section-detail" class="plant-detail">
                        <!-- El contenido de la secci√≥n se mostrar√° aqu√≠ -->
                    </div>
                </div>
            </div>
            
            <div class="plants-grid">
                <div class="plant-card" onclick="togglePlant(1)" 
                     ondrop="dropToPlant(event, 1)" ondragover="allowDrop(event)">
                    <div class="plant-icon">üè≠</div>
                    <div class="plant-title">Planta 1</div>
                    <div class="plant-status">Dep√≥sito disponible</div>
                </div>
                
                <div class="plant-card" onclick="togglePlant(2)" 
                     ondrop="dropToPlant(event, 2)" ondragover="allowDrop(event)">
                    <div class="plant-icon">üè≠</div>
                    <div class="plant-title">Planta 2</div>
                    <div class="plant-status">2 m√°quinas activas</div>
                </div>
                
                <div class="plant-card" onclick="togglePlant(3)" 
                     ondrop="dropToPlant(event, 3)" ondragover="allowDrop(event)">
                    <div class="plant-icon">üè≠</div>
                    <div class="plant-title">Planta 3</div>
                    <div class="plant-status">Dep√≥sito disponible</div>
                </div>
            </div>
            
            <!-- Detalle Planta 1 -->
            <div id="plant1-detail" class="plant-detail">
                <h3>üè≠ Planta 1 - Detalle</h3>
                <div class="plant2-layout">
                    <div class="deposit-section">
                        <div class="detail-card deposit-card">
                            <div class="detail-icon">üì¶</div>
                            <div class="detail-title">Dep√≥sito de Materias Primas</div>
                            <div class="materials-list" id="plant1MaterialsList">
                                <!-- Los materiales se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                    <div class="machines-section">
                        <div class="machine-card" ondrop="drop(event, 'plant1MachineA')" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚öôÔ∏è</div>
                            <div class="detail-title">M√°quina A</div>
                            <div class="machine-materials" id="plant1MachineA-materials">
                                <div class="drop-zone">Arrastra materiales aqu√≠</div>
                            </div>
                        </div>
                        <div class="machine-card" ondrop="drop(event, 'plant1MachineB')" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚öôÔ∏è</div>
                            <div class="detail-title">M√°quina B</div>
                            <div class="machine-materials" id="plant1MachineB-materials">
                                <div class="drop-zone">Arrastra materiales aqu√≠</div>
                            </div>
                        </div>
                    </div>
                    <div class="rejected-section">
                        <div class="rejected-card" ondrop="dropToRejected(event)" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚ùå</div>
                            <div class="detail-title">Rechazados</div>
                            <div class="rejected-materials" id="plant1RejectedMaterials">
                                <div class="drop-zone">Arrastra materiales rechazados aqu√≠</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detalle Planta 2 -->
            <div id="plant2-detail" class="plant-detail">
                <h3>üè≠ Planta 2 - Detalle</h3>
                <div class="plant2-layout">
                    <div class="deposit-section">
                        <div class="detail-card deposit-card">
                            <div class="detail-icon">üì¶</div>
                            <div class="detail-title">Dep√≥sito de Materias Primas</div>
                            <div class="materials-list" id="plant2MaterialsList">
                                <!-- Los materiales se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                    <div class="machines-section">
                        <div class="machine-card" ondrop="drop(event, 'plant2MachineA')" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚öôÔ∏è</div>
                            <div class="detail-title">Adulto 4</div>
                            <div class="machine-materials" id="plant2MachineA-materials">
                                <div class="drop-zone">Arrastra materiales aqu√≠</div>
                            </div>
                        </div>
                        <div class="machine-card" ondrop="drop(event, 'plant2MachineB')" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚öôÔ∏è</div>
                            <div class="detail-title">Adulto 5</div>
                            <div class="machine-materials" id="plant2MachineB-materials">
                                <div class="drop-zone">Arrastra materiales aqu√≠</div>
                            </div>
                        </div>
                    </div>
                    <div class="rejected-section">
                        <div class="rejected-card" ondrop="dropToRejected(event)" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚ùå</div>
                            <div class="detail-title">Rechazados</div>
                            <div class="rejected-materials" id="rejectedMaterials">
                                <div class="drop-zone">Arrastra materiales rechazados aqu√≠</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Detalle Planta 3 -->
            <div id="plant3-detail" class="plant-detail">
                <h3>üè≠ Planta 3 - Detalle</h3>
                <div class="plant2-layout">
                    <div class="deposit-section">
                        <div class="detail-card deposit-card">
                            <div class="detail-icon">üì¶</div>
                            <div class="detail-title">Dep√≥sito de Materias Primas</div>
                            <div class="materials-list" id="plant3MaterialsList">
                                <!-- Los materiales se cargar√°n aqu√≠ -->
                            </div>
                        </div>
                    </div>
                    <div class="machines-section">
                        <div class="machine-card" ondrop="drop(event, 'plant3MachineA')" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚öôÔ∏è</div>
                            <div class="detail-title">M√°quina A</div>
                            <div class="machine-materials" id="plant3MachineA-materials">
                                <div class="drop-zone">Arrastra materiales aqu√≠</div>
                            </div>
                        </div>
                        <div class="machine-card" ondrop="drop(event, 'plant3MachineB')" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚öôÔ∏è</div>
                            <div class="detail-title">M√°quina B</div>
                            <div class="machine-materials" id="plant3MachineB-materials">
                                <div class="drop-zone">Arrastra materiales aqu√≠</div>
                            </div>
                        </div>
                    </div>
                    <div class="rejected-section">
                        <div class="rejected-card" ondrop="dropToRejected(event)" ondragover="allowDrop(event)">
                            <div class="detail-icon">‚ùå</div>
                            <div class="detail-title">Rechazados</div>
                            <div class="rejected-materials" id="plant3RejectedMaterials">
                                <div class="drop-zone">Arrastra materiales rechazados aqu√≠</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
        
        <footer class="main-footer">
            <a href="../index.html" class="footer-link">
                üè† Volver a Utilidades Principal
            </a>
        </footer>
    </div>

    <!-- Modal para registrar rechazo -->
    <div id="rejectionModal" class="rejection-modal">
        <div class="modal-content">
            <h3>Registrar Rechazo</h3>
            <p>Material: <span id="rejectedMaterialName"></span></p>
            <input type="text" id="rejectedBy" class="modal-input" placeholder="Rechazado por (nombre)" required>
            <textarea id="rejectionReason" class="modal-input" placeholder="Motivo del rechazo" rows="3" required></textarea>
            <div>
                <button class="modal-btn" onclick="confirmRejection()">Confirmar Rechazo</button>
                <button class="modal-btn cancel" onclick="cancelRejection()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para detalles de producto -->
    <div id="productModal" class="rejection-modal">
        <div class="modal-content">
            <h3>Detalles del Producto</h3>
            <p>Producto: <span id="modalProductName"></span></p>
            <input type="number" id="productWeight" class="modal-input" placeholder="Peso (kg)" required>
            <input type="date" id="entryDate" class="modal-input" required>
            <input type="text" id="productLot" class="modal-input" placeholder="Lote" required>
            <div id="generatedCode" style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; font-weight: bold;"></div>
            <div style="margin: 15px 0;">
                <div id="qrPreview" style="text-align: center; margin: 10px 0;"></div>
            </div>
            <div>
                <button class="modal-btn" onclick="generateQR()">Regenerar QR</button>
                <button class="modal-btn" onclick="downloadQR()" id="downloadBtn" style="display: none;">Descargar QR</button>
                <button class="modal-btn" onclick="confirmProduct()">Confirmar</button>
                <button class="modal-btn cancel" onclick="cancelProduct()">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="state-validator.js"></script>
    <script src="auth.js"></script>
    <script src="product-state-manager.js"></script>
    <script src="plant-manager.js"></script>
    <script src="dashboard-stats.js"></script>
    
    <script>
        // Validaci√≥n peri√≥dica del estado
        setInterval(() => {
            const inventory = plantManager.getInventoryData();
            const machineData = plantManager.getMachineData();
            
            // Forzar una recarga si se detectan cambios
            if (activePlant) {
                plantManager.loadPlantMaterials(activePlant);
                plantManager.loadMachineState();
            }
        }, 30000); // Validar cada 30 segundos
    </script>

    <!-- Modal para historial de producto -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <h3>Historial del Producto</h3>
            <div id="productHistory"></div>
            <button class="modal-btn" onclick="closeHistoryModal()">Cerrar</button>
        </div>
    </div>

    <script>
        function showProductHistory(productId) {
            const history = productStateManager.getProductHistory(productId);
            const currentLocation = productStateManager.getCurrentLocation(productId);
            
            let html = `<p><strong>Ubicaci√≥n actual:</strong> ${currentLocation}</p><hr>`;
            html += '<h4>Historial de movimientos:</h4>';
            
            if (history.length === 0) {
                html += '<p>No hay movimientos registrados</p>';
            } else {
                html += '<ul style="list-style-type: none; padding: 0;">';
                history.forEach(move => {
                    const date = new Date(move.timestamp).toLocaleString();
                    html += `
                        <li style="margin-bottom: 10px; padding: 5px; border-left: 3px solid #ccc;">
                            <strong>${date}</strong><br>
                            De: ${move.from}<br>
                            A: ${move.to}<br>
                            ${move.reason ? `Raz√≥n: ${move.reason}` : ''}
                        </li>
                    `;
                });
                html += '</ul>';
            }
            
            document.getElementById('productHistory').innerHTML = html;
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }
    </script>

    <script>
        let activePlant = null;

        // Funci√≥n para reiniciar el stock de las plantas
        function resetPlantStock() {
            if (confirm('¬øEst√°s seguro de que deseas reiniciar el stock de todas las plantas? Esta acci√≥n no se puede deshacer.')) {
                showLoadingIndicator();
                
                setTimeout(() => {
                    plantManager.initializePlants();
                    
                    // Recargar la vista actual si hay una planta activa
                    if (activePlant) {
                        plantManager.loadPlantMaterials(activePlant);
                        plantManager.loadMachineState();
                    }
                    
                    hideLoadingIndicator();
                    showNotification('Stock de plantas reiniciado correctamente', 'success');
                }, 500);
            }
        }
        
        // Sistema de notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? 'var(--success-500)' : type === 'warning' ? 'var(--warning-500)' : type === 'error' ? 'var(--error-500)' : 'var(--primary-500)'};
                    color: white;
                    padding: 16px 24px;
                    border-radius: var(--radius-lg);
                    box-shadow: var(--shadow-lg);
                    z-index: 1000;
                    animation: slideIn 0.3s ease-out;
                    max-width: 300px;
                ">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span>${type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                        ${message}
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-remover despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Inicializar plantas al cargar la p√°gina
        window.addEventListener('load', function() {
            // Solo inicializar si es la primera vez
            const firstLoad = !localStorage.getItem('stockeando_initialized');
            if (firstLoad) {
                plantManager.initializePlants();
                localStorage.setItem('stockeando_initialized', 'true');
            } else {
                // Validar inventario existente una sola vez
                plantManager.initializeWithValidation();
            }
        });

        function togglePlant(plantNumber) {
            // Agregar feedback h√°ptico
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            if (activePlant === plantNumber) {
                const detail = document.getElementById(`plant${plantNumber}-detail`);
                detail.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    detail.classList.remove('show');
                    detail.style.animation = '';
                }, 300);
                document.querySelectorAll('.plant-card')[plantNumber - 1].classList.remove('active');
                activePlant = null;
                return;
            }

            document.querySelectorAll('.plant-detail').forEach(detail => {
                detail.classList.remove('show');
            });
            document.querySelectorAll('.plant-card, .section-card').forEach(card => {
                card.classList.remove('active');
            });

            const detail = document.getElementById(`plant${plantNumber}-detail`);
            detail.classList.add('show');
            detail.style.animation = 'slideIn 0.5s ease-out';
            
            document.querySelectorAll('.plant-card')[plantNumber - 1].classList.add('active');
            activePlant = plantNumber;

            // Mostrar indicador de carga
            showLoadingIndicator();

            // Cargar contenido seg√∫n la planta
            plantManager.loadPlantMaterials(plantNumber);

            detail.scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // Cargar estado de m√°quinas despu√©s de mostrar la planta
            setTimeout(() => {
                plantManager.loadMachineState();
                hideLoadingIndicator();
            }, 100);
        }
        
        function showLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'loading-indicator';
            indicator.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--primary-500);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: var(--shadow-lg);
                    z-index: 1000;
                    animation: slideIn 0.3s ease-out;
                ">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="animate-pulse">‚è≥</div>
                        Cargando...
                    </div>
                </div>
            `;
            document.body.appendChild(indicator);
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) {
                indicator.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => indicator.remove(), 300);
            }
        }
        
        function loadPlantProducts(plantNumber) {
            const inventory = getInventoryData();
            const products = inventory[`planta${plantNumber}`] || [];
            const container = document.getElementById(`plant${plantNumber}-products`);
            
            if (products.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; margin: 20px 0;">No hay productos en esta planta</p>';
                return;
            }
            
            container.innerHTML = products.map((product, index) => `
                <div class="product-item-card">
                    <div class="product-name">${product.name}</div>
                    <div class="product-measure">${product.measure}</div>
                    <div class="product-lot">Lote: ${product.lot}</div>
                    <div class="product-code">C√≥d: ${product.code}</div>
                    <div class="product-code">Fecha: ${product.entryDate}</div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="request-btn" onclick="showPlantProductDetails(${plantNumber}, ${index})">Detalles</button>
                        <button class="delete-btn" onclick="deletePlantProduct(${plantNumber}, ${index})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }
        
        function showPlantProductDetails(plantNumber, index) {
            showPlantMaterialDetails(plantNumber, index);
        }
        
        function showPlantMaterialDetails(plantNumber, index) {
            const inventory = getInventoryData();
            const product = inventory[`planta${plantNumber}`][index];
            
            if (!product) return;
            
            // Calcular fecha de vencimiento (ejemplo: 6 meses desde ingreso)
            let expirationDate = 'No definido';
            if (product.entryDate) {
                const entry = new Date(product.entryDate);
                entry.setMonth(entry.getMonth() + 6);
                expirationDate = entry.toLocaleDateString('es-ES');
            }
            
            const detailsModal = document.createElement('div');
            detailsModal.className = 'rejection-modal';
            detailsModal.style.display = 'block';
            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3>üè¢ Detalles del Material - Planta ${plantNumber}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <p><strong>üì¶ Producto:</strong> ${product.name}</p>
                            <p><strong>üìè Medida:</strong> ${product.measure || 'N/A'}</p>
                            <p><strong>‚öñÔ∏è Peso:</strong> ${product.weight || 'N/A'}kg</p>
                            <p><strong>üìÖ Fecha Ingreso:</strong> ${product.entryDate || 'N/A'}</p>
                        </div>
                        <div>
                            <p><strong>üè∑Ô∏è Lote:</strong> ${product.lot || 'N/A'}</p>
                            <p><strong>üî¢ C√≥digo:</strong> ${product.code || 'N/A'}</p>
                            <p><strong>‚è∞ Vencimiento:</strong> ${expirationDate}</p>
                            <p><strong>üìç Ubicaci√≥n:</strong> Planta ${plantNumber}</p>
                        </div>
                    </div>
                    ${product.qrUrl ? `
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>üì± C√≥digo QR</h4>
                            <img src="${product.qrUrl}" alt="QR Code" style="border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                            <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                <strong>Informaci√≥n del QR:</strong><br>
                                ${product.name}<br>
                                Peso: ${product.weight || 'N/A'}kg | Fecha: ${product.entryDate || 'N/A'}<br>
                                Lote: ${product.lot || 'N/A'} | C√≥digo: ${product.code || 'N/A'}
                            </div>
                        </div>
                    ` : '<div style="text-align: center; padding: 20px; color: #999;">üì± No hay c√≥digo QR disponible</div>'}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="modal-btn cancel" onclick="this.closest('.rejection-modal').remove()">Cerrar</button>
                        ${product.qrUrl ? `<button class="modal-btn" onclick="downloadProductQR('${product.name}', '${product.lot}', '${product.qrUrl}')">üì• Descargar QR</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(detailsModal);
        }
        
        function deletePlantProduct(plantNumber, index) {
            const inventory = getInventoryData();
            const product = inventory[`planta${plantNumber}`][index];
            
            if (!inventory.eliminados) inventory.eliminados = [];
            inventory.eliminados.push({...product, deletedFrom: `planta${plantNumber}`});
            inventory[`planta${plantNumber}`].splice(index, 1);
            saveInventoryData(inventory);
            loadPlantProducts(plantNumber);
        }

        // Las m√°quinas solo pueden enviar materiales a rechazados, no de vuelta al dep√≥sito
        
        // Funciones de rechazo ahora manejadas por PlantManager

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
            
            // Agregar efecto de vibraci√≥n sutil
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.material);
            ev.dataTransfer.setData("source", "deposit");
            ev.dataTransfer.setData("element", ev.target.outerHTML);
            
            // Agregar clase de arrastre
            ev.target.classList.add('dragging');
            ev.target.style.opacity = '0.5';
            ev.target.style.transform = 'rotate(5deg) scale(0.95)';
            
            // Feedback h√°ptico
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        function drop(ev, machineId) {
            // Usar PlantManager para todas las plantas
            plantManager.moveToMachine(ev, machineId);
            
            const originalElement = document.querySelector(`[data-material="${materialName}"]`);
            if (originalElement) originalElement.remove();
        }

        function dragFromMachine(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.material);
            ev.dataTransfer.setData("source", "machine");
            ev.dataTransfer.setData("element", ev.target.outerHTML);
        }

        function dropToDeposit(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const source = ev.dataTransfer.getData("source");
            if (source !== "machine") return;
            
            const materialName = ev.dataTransfer.getData("text");
            const materialsList = document.getElementById('materialsList');
            
            // Solo permitir devolver materiales reales de planta 2
            const inventory = getInventoryData();
            const plant2Materials = inventory.planta2 || [];
            const originalMaterial = plant2Materials.find(m => m.name === materialName);
            if (!originalMaterial) return;
            
            // Recargar la vista del dep√≥sito
            loadMaterials();
            
            // Remover de la m√°quina
            const machineElement = document.querySelector(`.machine-material[data-material="${materialName}"]`);
            if (machineElement) {
                machineElement.remove();
            }
        }

        let pendingRejection = null;

        function dropToRejected(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const source = ev.dataTransfer.getData("source");
            if (source !== "machine") return;
            
            const materialName = ev.dataTransfer.getData("text");
            const materialId = ev.dataTransfer.getData("materialId");
            const machineId = ev.dataTransfer.getData("machineId");
            
            // Determinar planta desde machineId
            let plantNumber = null;
            if (machineId.includes('plant1')) plantNumber = 1;
            else if (machineId.includes('plant2')) plantNumber = 2;
            else if (machineId.includes('plant3')) plantNumber = 3;
            
            // Guardar datos para el modal
            pendingRejection = {
                materialName: materialName,
                materialId: materialId,
                machineId: machineId,
                plantNumber: plantNumber,
                sourceElement: document.querySelector(`#${machineId}-materials .machine-material[data-material="${materialName}"]`)
            };
            
            // Mostrar modal
            document.getElementById('rejectedMaterialName').textContent = materialName;
            document.getElementById('rejectionModal').style.display = 'block';
        }

        function confirmRejection() {
            const rejectedBy = document.getElementById('rejectedBy').value.trim();
            const reason = document.getElementById('rejectionReason').value.trim();
            
            if (!rejectedBy || !reason) {
                showNotification('Por favor completa todos los campos', 'warning');
                return;
            }
            
            const rejectionInfo = {
                rejectedBy,
                reason,
                timestamp: new Date().toISOString()
            };
            
            // PRIMERO: Obtener datos completos del material desde la m√°quina ANTES de eliminarlo
            let materialData = null;
            if (pendingRejection.machineId) {
                const machineData = plantManager.getMachineData();
                if (machineData[pendingRejection.machineId]) {
                    materialData = machineData[pendingRejection.machineId].find(m => m.name === pendingRejection.materialName);
                }
            }
            
            // Si no se encuentran datos en la m√°quina, usar datos b√°sicos
            if (!materialData) {
                materialData = {
                    name: pendingRejection.materialName,
                    measure: 'N/A',
                    weight: 'N/A',
                    entryDate: 'N/A',
                    lot: 'N/A',
                    code: 'N/A',
                    qrUrl: null
                };
            }
            
            // Generar QR de rechazo
            const rejectionDate = new Date().toLocaleDateString('es-ES');
            const rejectionQRText = `${materialData.name}\nPeso: ${materialData.weight}kg\nLote: ${materialData.lot}\nC√≥digo: ${materialData.code}\nFecha Ingreso: ${materialData.entryDate}\nRECHAZADO: ${rejectionDate}\nMotivo: ${reason}\nRechazado por: ${rejectedBy}`;
            const rejectionQRUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(rejectionQRText)}`;
            
            // Agregar QR de rechazo a los datos del material
            materialData.rejectionQRUrl = rejectionQRUrl;
            materialData.rejectionDate = rejectionDate;
            materialData.rejectionReason = reason;
            materialData.rejectedBy = rejectedBy;
            
            // Determinar el contenedor de rechazados seg√∫n la planta
            let rejectedContainer;
            if (pendingRejection.plantNumber) {
                // Seleccionar contenedor correcto seg√∫n la planta
                if (pendingRejection.plantNumber === 1) {
                    rejectedContainer = document.getElementById('plant1RejectedMaterials');
                } else if (pendingRejection.plantNumber === 2) {
                    rejectedContainer = document.getElementById('rejectedMaterials');
                } else if (pendingRejection.plantNumber === 3) {
                    rejectedContainer = document.getElementById('plant3RejectedMaterials');
                }
                
                // Registrar el rechazo en el sistema de seguimiento
                productStateManager.registerRejection(
                    pendingRejection.materialId,
                    pendingRejection.machineId || `planta${pendingRejection.plantNumber}_machine`,
                    reason
                );
                
                // SEGUNDO: Remover de la m√°quina DESPU√âS de obtener los datos
                if (pendingRejection.sourceElement) {
                    pendingRejection.sourceElement.remove();
                    
                    // Eliminar tambi√©n de los datos de la m√°quina
                    if (pendingRejection.machineId) {
                        const machineDataToUpdate = plantManager.getMachineData();
                        if (machineDataToUpdate[pendingRejection.machineId]) {
                            const materialIndex = machineDataToUpdate[pendingRejection.machineId].findIndex(m => m.name === pendingRejection.materialName);
                            if (materialIndex !== -1) {
                                machineDataToUpdate[pendingRejection.machineId].splice(materialIndex, 1);
                                plantManager.saveMachineData(machineDataToUpdate);
                            }
                        }
                    }
                    
                    // Actualizar estado de m√°quinas
                    plantManager.saveMachineState();
                }
            } else {
                // Fallback a planta 2 si no se puede determinar
                rejectedContainer = document.getElementById('rejectedMaterials');
                if (pendingRejection.sourceElement) {
                    pendingRejection.sourceElement.remove();
                }
            }
            
            // Remover mensaje de drop zone si existe
            const dropZone = rejectedContainer.querySelector('.drop-zone');
            if (dropZone) dropZone.remove();
            
            // Agregar material rechazado
            const rejectedDiv = document.createElement('div');
            rejectedDiv.className = 'rejected-material';
            rejectedDiv.innerHTML = `
                <strong>${pendingRejection.materialName}</strong><br>
                <small>Rechazado por: ${rejectedBy}</small><br>
                <small>Motivo: ${reason}</small>
            `;
            rejectedContainer.appendChild(rejectedDiv);
            
            // Guardar en lista global de rechazados (usando datos obtenidos arriba)
            const rejectedProducts = getRejectedProducts();
            rejectedProducts.push({
                name: pendingRejection.materialName,
                rejectedBy: rejectedBy,
                reason: reason,
                plantNumber: pendingRejection.plantNumber || 2,
                date: new Date().toISOString().split('T')[0],
                materialData: materialData
            });
            saveRejectedProducts(rejectedProducts);
            
            // Mostrar QR de rechazo generado
            showRejectionQRModal(materialData, rejectedBy, reason, rejectionDate);
            
            // Cerrar modal de rechazo
            cancelRejection();
        }
        
        function getRejectedProducts() {
            return JSON.parse(localStorage.getItem('stockeando_rejected')) || [];
        }
        
        function saveRejectedProducts(data) {
            localStorage.setItem('stockeando_rejected', JSON.stringify(data));
        }
        
        function reprocessRejected(index) {
            const rejectedProducts = getRejectedProducts();
            const product = rejectedProducts[index];
            
            // Mover a pedidos para reprocesar
            const inventory = getInventoryData();
            const newProduct = {
                name: product.name,
                measure: product.measure || 'N/A',
                category: 'Reproceso',
                quantity: 1,
                status: 'pendiente'
            };
            
            inventory.pedidos.push(newProduct);
            saveInventoryData(inventory);
            
            // Eliminar de rechazados
            rejectedProducts.splice(index, 1);
            saveRejectedProducts(rejectedProducts);
            
            showSectionDetail('eliminados');
        }
        
        function permanentDeleteRejected(index) {
            const rejectedProducts = getRejectedProducts();
            rejectedProducts.splice(index, 1);
            saveRejectedProducts(rejectedProducts);
            showSectionDetail('eliminados');
        }
        
        function showEliminatedProductDetails(index) {
            const inventory = getInventoryData();
            const product = inventory.eliminados[index];
            
            if (!product) return;
            
            // Calcular fecha de vencimiento
            let expirationDate = 'No definido';
            if (product.entryDate) {
                const entry = new Date(product.entryDate);
                entry.setMonth(entry.getMonth() + 6);
                expirationDate = entry.toLocaleDateString('es-ES');
            }
            
            const detailsModal = document.createElement('div');
            detailsModal.className = 'rejection-modal';
            detailsModal.style.display = 'block';
            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3>üóëÔ∏è Producto Eliminado - Detalles</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <p><strong>üì¶ Producto:</strong> ${product.name}</p>
                            <p><strong>üìè Medida:</strong> ${product.measure || 'N/A'}</p>
                            <p><strong>‚öñÔ∏è Peso:</strong> ${product.weight || 'N/A'}kg</p>
                            <p><strong>üìÖ Fecha Ingreso:</strong> ${product.entryDate || 'N/A'}</p>
                        </div>
                        <div>
                            <p><strong>üè∑Ô∏è Lote:</strong> ${product.lot || 'N/A'}</p>
                            <p><strong>üî¢ C√≥digo:</strong> ${product.code || 'N/A'}</p>
                            <p><strong>‚è∞ Vencimiento:</strong> ${expirationDate}</p>
                            <p><strong>üìç Eliminado de:</strong> ${product.deletedFrom || 'N/A'}</p>
                        </div>
                    </div>
                    ${product.qrUrl ? `
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>üì± C√≥digo QR</h4>
                            <img src="${product.qrUrl}" alt="QR Code" style="border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                            <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                <strong>Informaci√≥n del QR:</strong><br>
                                ${product.name}<br>
                                Peso: ${product.weight || 'N/A'}kg | Fecha: ${product.entryDate || 'N/A'}<br>
                                Lote: ${product.lot || 'N/A'} | C√≥digo: ${product.code || 'N/A'}
                            </div>
                        </div>
                    ` : '<div style="text-align: center; padding: 20px; color: #999;">üì± No hay c√≥digo QR disponible</div>'}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="modal-btn cancel" onclick="this.closest('.rejection-modal').remove()">Cerrar</button>
                        ${product.qrUrl ? `<button class="modal-btn" onclick="downloadProductQR('${product.name}', '${product.lot}', '${product.qrUrl}')">üì• Descargar QR</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(detailsModal);
        }
        
        function showRejectedProductDetails(index) {
            const rejectedProducts = getRejectedProducts();
            const product = rejectedProducts[index];
            
            if (!product) return;
            
            // Usar datos del material original si est√°n disponibles
            const materialData = product.materialData || product;
            
            // Calcular fecha de vencimiento
            let expirationDate = 'No definido';
            if (materialData.entryDate) {
                const entry = new Date(materialData.entryDate);
                entry.setMonth(entry.getMonth() + 6);
                expirationDate = entry.toLocaleDateString('es-ES');
            }
            
            const detailsModal = document.createElement('div');
            detailsModal.className = 'rejection-modal';
            detailsModal.style.display = 'block';
            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3>‚ùå Producto Rechazado - Detalles</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <p><strong>üì¶ Producto:</strong> ${materialData.name}</p>
                            <p><strong>üìè Medida:</strong> ${materialData.measure || 'N/A'}</p>
                            <p><strong>‚öñÔ∏è Peso:</strong> ${materialData.weight || 'N/A'}kg</p>
                            <p><strong>üìÖ Fecha Ingreso:</strong> ${materialData.entryDate || 'N/A'}</p>
                        </div>
                        <div>
                            <p><strong>üè∑Ô∏è Lote:</strong> ${materialData.lot || 'N/A'}</p>
                            <p><strong>üî¢ C√≥digo:</strong> ${materialData.code || 'N/A'}</p>
                            <p><strong>‚è∞ Vencimiento:</strong> ${expirationDate}</p>
                            <p><strong>üìç Planta:</strong> ${product.plantNumber || 'N/A'}</p>
                        </div>
                    </div>
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f44336;">
                        <h4 style="color: #d32f2f; margin-bottom: 10px;">‚ùå Informaci√≥n del Rechazo</h4>
                        <p><strong>Rechazado por:</strong> ${product.rejectedBy}</p>
                        <p><strong>Motivo:</strong> ${product.reason}</p>
                        <p><strong>Fecha de rechazo:</strong> ${product.date || 'N/A'}</p>
                    </div>
                    ${materialData.rejectionQRUrl ? `
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #ffebee; border-radius: 8px; border: 2px solid #f44336;">
                            <h4 style="color: #d32f2f;">üì± QR de Rechazo</h4>
                            <img src="${materialData.rejectionQRUrl}" alt="QR Rechazo" style="border: 2px solid #f44336; border-radius: 8px; margin: 10px 0;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #d32f2f; margin-top: 10px; text-transform: uppercase;">
                                RECHAZADO
                            </div>
                        </div>
                    ` : materialData.qrUrl ? `
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>üì± C√≥digo QR Original</h4>
                            <img src="${materialData.qrUrl}" alt="QR Code" style="border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                        </div>
                    ` : '<div style="text-align: center; padding: 20px; color: #999;">üì± No hay c√≥digo QR disponible</div>'}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="modal-btn cancel" onclick="this.closest('.rejection-modal').remove()">Cerrar</button>
                        ${materialData.rejectionQRUrl ? `<button class="modal-btn" onclick="downloadRejectionQR('${materialData.name}', '${materialData.lot}', '${materialData.rejectionQRUrl}')">üì• Descargar QR Rechazo</button>` : ''}
                        ${materialData.qrUrl ? `<button class="modal-btn" onclick="downloadProductQR('${materialData.name}', '${materialData.lot}', '${materialData.qrUrl}')">üì• Descargar QR Original</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(detailsModal);
        }
        
        function showRejectionQRModal(materialData, rejectedBy, reason, rejectionDate) {
            const modal = document.createElement('div');
            modal.className = 'rejection-modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <h3 style="color: #d32f2f; text-align: center;">‚ùå QR de Rechazo Generado</h3>
                    <div style="text-align: center; margin: 20px 0; padding: 20px; background: #ffebee; border-radius: 8px; border: 2px solid #f44336;">
                        <img src="${materialData.rejectionQRUrl}" alt="QR Rechazo" style="border: 2px solid #f44336; border-radius: 8px; margin: 10px 0; max-width: 100%;">
                        <div style="font-size: 1.5em; font-weight: bold; color: #d32f2f; margin-top: 15px; text-transform: uppercase; letter-spacing: 2px;">
                            RECHAZADO
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            <strong>${materialData.name}</strong><br>
                            Fecha: ${rejectionDate}<br>
                            Motivo: ${reason}
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="modal-btn" onclick="downloadRejectionQR('${materialData.name}', '${materialData.lot}', '${materialData.rejectionQRUrl}')">üì• Descargar QR</button>
                        <button class="modal-btn cancel" onclick="this.closest('.rejection-modal').remove()">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function downloadRejectionQR(productName, lot, qrUrl) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 400;
            canvas.height = 500;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';
            tempImg.onload = function() {
                // QR Code
                ctx.drawImage(tempImg, 50, 50, 300, 300);
                
                // Texto "RECHAZADO" grande y rojo
                ctx.fillStyle = '#d32f2f';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('RECHAZADO', canvas.width / 2, 400);
                
                // Producto y lote
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = '#333';
                ctx.fillText(productName, canvas.width / 2, 440);
                
                ctx.font = '14px Arial';
                ctx.fillText(`Lote: ${lot}`, canvas.width / 2, 465);
                
                // Fecha
                const fecha = new Date().toLocaleDateString('es-ES');
                ctx.font = '12px Arial';
                ctx.fillText(`Fecha rechazo: ${fecha}`, canvas.width / 2, 485);
                
                const link = document.createElement('a');
                link.download = `QR_RECHAZADO_${productName}_${lot}.png`;
                link.href = canvas.toDataURL();
                link.click();
            };
            tempImg.src = qrUrl;
        }

        function cancelRejection() {
            document.getElementById('rejectionModal').style.display = 'none';
            document.getElementById('rejectedBy').value = '';
            document.getElementById('rejectionReason').value = '';
            pendingRejection = null;
        }

        // Remover clase drag-over cuando se sale del √°rea
        document.addEventListener('dragleave', function(e) {
            if (e.target.classList.contains('machine-card') || 
                e.target.classList.contains('deposit-card') || 
                e.target.classList.contains('rejected-card') ||
                e.target.classList.contains('plant-card') ||
                e.target.classList.contains('section-card')) {
                e.target.classList.remove('drag-over');
            }
        });
        
        // Remover efectos de arrastre al terminar
        document.addEventListener('dragend', function(e) {
            if (e.target.classList.contains('dragging')) {
                e.target.classList.remove('dragging');
                e.target.style.opacity = '';
                e.target.style.transform = '';
            }
        });

        // Cargar categor√≠as desde localStorage
        function loadCategories() {
            return JSON.parse(localStorage.getItem('stockeando_categories')) || {};
        }

        // Funci√≥n para manejar secciones superiores
        function toggleSection(sectionType) {
            // Si la secci√≥n ya est√° activa, cerrarla
            if (activeSection === sectionType) {
                document.getElementById('section-detail').classList.remove('show');
                document.querySelectorAll('.section-card').forEach(card => {
                    card.classList.remove('active');
                });
                activeSection = null;
                return;
            }
            
            // Remover active de todas las secciones y plantas
            document.querySelectorAll('.section-card, .plant-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelectorAll('.plant-detail').forEach(detail => {
                detail.classList.remove('show');
            });
            
            // Agregar active solo a la secci√≥n clickeada
            event.target.closest('.section-card').classList.add('active');
            
            // Mostrar detalle de la secci√≥n
            showSectionDetail(sectionType);
            activePlant = null;
        }

        let activeSection = null;
        let activeSectionCategory = null;

        function showSectionDetail(sectionType) {
            const categories = loadCategories();
            const inventory = getInventoryData();
            const sectionDetail = document.getElementById('section-detail');
            activeSection = sectionType;
            activeSectionCategory = null;
            
            const sectionTitles = {
                'pedidos': 'üìã Pedidos Pendientes',
                'transito': 'üöö Materiales en Tr√°nsito', 
                'deposito': 'üè¢ Dep√≥sito General',
                'eliminados': 'üóëÔ∏è Productos Eliminados/Rechazados'
            };
            
            const sectionProducts = inventory[sectionType] || [];
            
            if (sectionType === 'eliminados') {
                // Para Eliminados/Rechazados: mostrar en dos columnas
                const rejectedProducts = getRejectedProducts();
                
                sectionDetail.innerHTML = `
                    <h3>${sectionTitles[sectionType]}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                        <div>
                            <h4 style="color: #f44336; margin-bottom: 15px;">üóëÔ∏è Productos Eliminados</h4>
                            ${sectionProducts.length > 0 ? `
                                <div class="products-grid">
                                    ${sectionProducts.map((product, index) => `
                                        <div class="product-item-card" ondblclick="showEliminatedProductDetails(${index})">
                                            <div class="product-name">${product.name}</div>
                                            <div class="product-measure">${product.measure || (product.weight ? product.weight + 'kg' : '')}</div>
                                            ${product.lot ? `<div class="product-lot">Lote: ${product.lot}</div>` : ''}
                                            ${product.code ? `<div class="product-code">C√≥d: ${product.code}</div>` : ''}
                                            ${product.entryDate ? `<div class="product-code">Fecha: ${product.entryDate}</div>` : ''}
                                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                                <button class="request-btn" onclick="reingresarProduct(${index})">Reingresar</button>
                                                <button class="delete-btn" onclick="permanentDelete(${index})">Eliminar Definitivo</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>No hay productos eliminados</p>'}
                        </div>
                        <div>
                            <h4 style="color: #ff9800; margin-bottom: 15px;">‚ùå Productos Rechazados</h4>
                            ${rejectedProducts.length > 0 ? `
                                <div class="products-grid">
                                    ${rejectedProducts.map((product, index) => `
                                        <div class="product-item-card" style="border-left: 4px solid #ff9800;" ondblclick="showRejectedProductDetails(${index})">
                                            <div class="product-name">${product.name}</div>
                                            <div class="product-measure">Rechazado por: ${product.rejectedBy}</div>
                                            <div class="product-lot">Motivo: ${product.reason}</div>
                                            ${product.plantNumber ? `<div class="product-code">Planta: ${product.plantNumber}</div>` : ''}
                                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                                <button class="request-btn" onclick="reprocessRejected(${index})">Reprocesar</button>
                                                <button class="delete-btn" onclick="permanentDeleteRejected(${index})">Eliminar Definitivo</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p>No hay productos rechazados</p>'}
                        </div>
                    </div>
                `;
                sectionDetail.classList.add('show');
                sectionDetail.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            if (sectionType === 'transito') {
                // Para Tr√°nsito: mostrar productos con bot√≥n ingresar
                sectionDetail.innerHTML = `
                    <h3>${sectionTitles[sectionType]}</h3>
                    ${sectionProducts.length > 0 ? `
                        <div class="products-grid">
                            ${sectionProducts.map((product, index) => `
                                <div class="product-item-card product-in-transit">
                                    <div class="product-name">${product.name}</div>
                                    <div class="product-measure">${product.measure}</div>
                                    <div class="product-quantity">Cantidad: ${product.quantity || 1}</div>
                                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                                        <button class="enter-btn" onclick="enterProduct(${index})">Ingresar</button>
                                        <button class="delete-btn" onclick="deleteTransitProduct(${index})">Eliminar</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p>No hay productos en tr√°nsito</p>'}
                `;
            } else {
                // Para Pedidos y Dep√≥sito: mostrar categor√≠as y productos
                sectionDetail.innerHTML = `
                    <h3>${sectionTitles[sectionType]}</h3>
                    
                    ${sectionProducts.length > 0 ? `
                        <h4>Productos en ${sectionTitles[sectionType]}</h4>
                        <div class="products-grid">
                            ${sectionProducts.map((product, index) => `
                                <div class="product-item-card ${sectionType === 'pedidos' && product.status === 'solicitado' ? 'product-requested' : ''}" 
                                     ${sectionType === 'deposito' ? `draggable="true" ondragstart="dragFromDeposito(event, '${product.name}', '${product.measure}', ${index})" ondblclick="showProductDetailsModal(${index}, '${sectionType}')"` : `ondblclick="showProductDetailsModal(${index}, '${sectionType}')"`}>
                                    <div class="product-name">${product.name}</div>
                                    <div class="product-measure">${product.measure || product.weight + 'kg'}</div>
                                    ${product.quantity ? `<div class="product-quantity">Cantidad: ${product.quantity}</div>` : ''}
                                    ${product.lot ? `<div class="product-lot">Lote: ${product.lot}</div>` : ''}
                                    ${product.code ? `<div class="product-code">C√≥d: ${product.code}</div>` : ''}
                                    ${product.entryDate ? `<div class="product-code">Fecha: ${product.entryDate}</div>` : ''}
                                    ${sectionType === 'pedidos' && product.status !== 'solicitado' ? `
                                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                                            <button class="request-btn" onclick="requestProduct(${index})">Solicitar</button>
                                            <button class="delete-btn" onclick="deleteProduct(${index})">Eliminar</button>
                                        </div>
                                    ` : ''}
                                    ${sectionType === 'deposito' ? `
                                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                                            <button class="request-btn" onclick="showProductDetails(${index})">Detalles</button>
                                            <button class="delete-btn" onclick="deleteDepositProduct(${index})">Eliminar</button>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${sectionType === 'pedidos' ? `
                        <div class="category-filter">
                            <label>Filtrar por categor√≠a:</label>
                            <select class="filter-select" onchange="filterProductsByCategory(this.value)">
                                <option value="">Todas las categor√≠as</option>
                                ${Object.keys(categories).map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div id="products-table-container">
                            ${buildProductsTable(categories, '')}
                        </div>
                    ` : ''}
                `;
            }
            
            sectionDetail.classList.add('show');
            sectionDetail.scrollIntoView({ behavior: 'smooth' });
        }

        function dragFromDeposito(event, name, measure, index) {
            event.dataTransfer.setData('productName', name);
            event.dataTransfer.setData('productMeasure', measure);
            event.dataTransfer.setData('sourceIndex', index);
            event.dataTransfer.setData('dragType', 'deposito-product');
        }

        function dragFromPedidos(event, name, measure, index) {
            event.dataTransfer.setData('productName', name);
            event.dataTransfer.setData('productMeasure', measure);
            event.dataTransfer.setData('sourceIndex', index);
            event.dataTransfer.setData('dragType', 'pedidos-product');
        }

        function dragFromTransito(event, name, measure, index) {
            event.dataTransfer.setData('productName', name);
            event.dataTransfer.setData('productMeasure', measure);
            event.dataTransfer.setData('sourceIndex', index);
            event.dataTransfer.setData('dragType', 'transito-product');
        }

        function buildProductsTable(categories, filterCategory) {
            let allProducts = [];
            
            Object.keys(categories).forEach(categoryName => {
                if (!filterCategory || categoryName === filterCategory) {
                    const category = categories[categoryName];
                    if (category && category.items) {
                        category.items.forEach(item => {
                            allProducts.push({
                                category: categoryName,
                                name: item.name,
                                measure: item.measure
                            });
                        });
                    }
                }
            });
            
            if (allProducts.length === 0) {
                return '<p>No hay productos disponibles</p>';
            }
            
            return `
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Producto</th>
                            <th>Medida</th>
                            <th>Cantidad</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${allProducts.map((product, index) => `
                            <tr>
                                <td>${product.category}</td>
                                <td>${product.name}</td>
                                <td>${product.measure}</td>
                                <td>
                                    <input type="number" id="qty_${index}" min="1" value="1" style="width: 60px; padding: 4px; border: 1px solid #ccc; border-radius: 4px;">
                                </td>
                                <td>
                                    <button class="add-btn" onclick="addToPedidos('${product.name}', '${product.measure}', '${product.category}', ${index})">Agregar</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function filterProductsByCategory(categoryFilter) {
            const categories = loadCategories();
            const container = document.getElementById('products-table-container');
            container.innerHTML = buildProductsTable(categories, categoryFilter);
        }

        // Sistema de inventario con localStorage
        function getInventoryData() {
            return JSON.parse(localStorage.getItem('stockeando_inventory')) || {
                pedidos: [],
                transito: [],
                deposito: [],
                planta1: [],
                planta2: [],
                planta3: [],
                eliminados: [],
                rechazados: []
            };
        }

        function saveInventoryData(data) {
            localStorage.setItem('stockeando_inventory', JSON.stringify(data));
        }
        
        // Funciones de m√°quinas ahora manejadas por PlantManager

        // Drag and drop para productos
        function dragProduct(event, name, measure, category, index) {
            event.dataTransfer.setData('productName', name);
            event.dataTransfer.setData('productMeasure', measure);
            event.dataTransfer.setData('sourceCategory', category);
            event.dataTransfer.setData('sourceIndex', index);
            event.dataTransfer.setData('dragType', 'product');
        }

        function dropToSection(event, sectionType) {
            event.preventDefault();
            event.stopPropagation();
            
            const dragType = event.dataTransfer.getData('dragType');
            const productName = event.dataTransfer.getData('productName');
            const productMeasure = event.dataTransfer.getData('productMeasure');
            
            const inventory = getInventoryData();
            
            if (dragType === 'product') {
                // Desde categor√≠as
                if (sectionType === 'pedidos' || sectionType === 'transito') {
                    inventory[sectionType].push({ name: productName, measure: productMeasure });
                    saveInventoryData(inventory);
                    if (activeSection === sectionType) {
                        showSectionDetail(activeSection);
                    }
                } else if (sectionType === 'deposito') {
                    // Para dep√≥sito desde categor√≠as, abrir modal
                    pendingProductMove = {
                        productName: productName,
                        productMeasure: productMeasure,
                        sourceType: 'category',
                        targetType: sectionType
                    };
                    showProductModal(productName);
                }
            } else if (dragType === 'transito-product' && sectionType === 'deposito') {
                // Desde Tr√°nsito a Dep√≥sito General - abrir modal
                const sourceIndex = parseInt(event.dataTransfer.getData('sourceIndex'));
                pendingProductMove = {
                    productName: productName,
                    productMeasure: productMeasure,
                    sourceType: 'transito',
                    sourceIndex: sourceIndex,
                    targetType: sectionType
                };
                showProductModal(productName);
            } else if (dragType === 'pedidos-product') {
                // Desde Pedidos a Tr√°nsito o Dep√≥sito
                const sourceIndex = parseInt(event.dataTransfer.getData('sourceIndex'));
                if (sectionType === 'transito') {
                    const product = inventory.pedidos[sourceIndex];
                    inventory.pedidos.splice(sourceIndex, 1);
                    inventory.transito.push(product);
                    saveInventoryData(inventory);
                    if (activeSection === 'pedidos' || activeSection === 'transito') {
                        showSectionDetail(activeSection);
                    }
                } else if (sectionType === 'deposito') {
                    pendingProductMove = {
                        productName: productName,
                        productMeasure: productMeasure,
                        sourceType: 'pedidos',
                        sourceIndex: sourceIndex,
                        targetType: sectionType
                    };
                    showProductModal(productName);
                }
            }
        }



        function dropToPlant(event, plantNumber) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
            
            const dragType = event.dataTransfer.getData('dragType');
            
            // Validar que el origen sea v√°lido
            if (!['deposito-product', 'transito-product'].includes(dragType)) {
                console.log('Tipo de arrastre no v√°lido:', dragType);
                return;
            }
            if (dragType !== 'deposito-product' && dragType !== 'transito-product') return;
            
            const productName = event.dataTransfer.getData('productName');
            const productMeasure = event.dataTransfer.getData('productMeasure');
            const sourceIndex = parseInt(event.dataTransfer.getData('sourceIndex'));
            
            const inventory = getInventoryData();
            
            if (dragType === 'deposito-product') {
                // Desde Dep√≥sito General - mover directamente (ya tiene datos completos)
                const product = inventory.deposito[sourceIndex];
                
                if (product) {
                    inventory.deposito.splice(sourceIndex, 1);
                    
                    // Asegurar que el array de la planta existe
                    if (!inventory[`planta${plantNumber}`]) {
                        inventory[`planta${plantNumber}`] = [];
                    }
                    inventory[`planta${plantNumber}`].push(product);
                    saveInventoryData(inventory);
                    
                    if (activeSection === 'deposito') {
                        showSectionDetail('deposito');
                    }
                    
                    // Actualizar vista de planta si est√° activa
                    if (activePlant === plantNumber) {
                        plantManager.loadPlantMaterials(plantNumber);
                    }
                }
            } else if (dragType === 'transito-product') {
                // Desde Tr√°nsito - abrir modal para completar datos
                pendingProductMove = {
                    productName: productName,
                    productMeasure: productMeasure,
                    sourceType: 'transito',
                    sourceIndex: sourceIndex,
                    targetType: `planta${plantNumber}`
                };
                showProductModal(productName);
            }
        }

        let pendingProductMove = null;

        function showProductModal(productName) {
            document.getElementById('modalProductName').textContent = productName;
            document.getElementById('productModal').style.display = 'block';
            document.getElementById('qrPreview').innerHTML = '';
            
            // Establecer fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            
            // Generar c√≥digo interno autom√°ticamente usando ProductStateManager
            const internalCode = productStateManager.generateUniqueCode(productName);
            document.getElementById('generatedCode').textContent = `C√≥digo interno: ${internalCode}`;
            
            // Generar QR autom√°ticamente despu√©s de un breve delay
            setTimeout(() => {
                autoGenerateQR();
            }, 100);
        }
        
        function autoGenerateQR() {
            const productName = document.getElementById('modalProductName').textContent;
            const weight = document.getElementById('productWeight').value;
            const entryDate = document.getElementById('entryDate').value;
            const lot = document.getElementById('productLot').value;
            const code = document.getElementById('generatedCode').textContent.replace('C√≥digo interno: ', '');
            
            if (weight && lot && entryDate && code) {
                const qrText = `${productName}\nPeso: ${weight}kg\nFecha: ${entryDate}\nLote: ${lot}\nC√≥digo: ${code}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
                
                const qrPreview = document.getElementById('qrPreview');
                qrPreview.innerHTML = `
                    <img src="${qrUrl}" alt="QR Code" style="border: 1px solid #ccc;" id="qrImage">
                    <p><strong>QR generado autom√°ticamente</strong></p>
                `;
                
                document.getElementById('downloadBtn').style.display = 'inline-block';
            }
        }

        // Funci√≥n legacy mantenida para compatibilidad, pero ahora usa ProductStateManager
        function generateInternalCode(productName) {
            return productStateManager.generateUniqueCode(productName);
        }

        function generateQR() {
            const productName = document.getElementById('modalProductName').textContent;
            const weight = document.getElementById('productWeight').value;
            const entryDate = document.getElementById('entryDate').value;
            const lot = document.getElementById('productLot').value;
            const code = document.getElementById('generatedCode').textContent.replace('C√≥digo interno: ', '');
            
            if (!weight || !entryDate || !lot || !code) {
                alert('Complete todos los campos para generar el QR');
                return;
            }
            
            const qrText = `${productName}\nPeso: ${weight}kg\nFecha: ${entryDate}\nLote: ${lot}\nC√≥digo: ${code}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
            
            const qrPreview = document.getElementById('qrPreview');
            qrPreview.innerHTML = `
                <img src="${qrUrl}" alt="QR Code" style="border: 1px solid #ccc;" id="qrImage">
                <p><strong>QR generado exitosamente</strong></p>
            `;
            
            document.getElementById('downloadBtn').style.display = 'inline-block';
        }

        function downloadQR() {
            const qrImage = document.getElementById('qrImage');
            const productName = document.getElementById('modalProductName').textContent;
            const lot = document.getElementById('productLot').value;
            
            if (qrImage) {
                const link = document.createElement('a');
                link.download = `QR_${productName}_${lot}.png`;
                link.href = qrImage.src;
                link.click();
            }
        }

        function confirmProduct() {
            if (!pendingProductMove) {
                alert('Error: No hay producto pendiente');
                return;
            }
            
            const weight = document.getElementById('productWeight').value;
            const entryDate = document.getElementById('entryDate').value;
            const lot = document.getElementById('productLot').value;
            
            if (!weight || !entryDate || !lot) {
                alert('Complete todos los campos requeridos');
                return;
            }
            
            const inventory = getInventoryData();
            const code = document.getElementById('generatedCode').textContent.replace('C√≥digo interno: ', '');
            
            // Validar que el c√≥digo sea √∫nico antes de continuar
            if (!productStateManager.isCodeUnique(code)) {
                showNotification('El c√≥digo generado ya existe. Regenerando...', 'warning');
                const newCode = productStateManager.generateUniqueCode(pendingProductMove.productName);
                document.getElementById('generatedCode').textContent = `C√≥digo interno: ${newCode}`;
                return;
            }
            
            // Obtener QR URL del preview o generar nueva
            let qrUrl = '';
            const qrImage = document.getElementById('qrImage');
            if (qrImage) {
                qrUrl = qrImage.src;
            } else {
                const qrText = `${pendingProductMove.productName}\nPeso: ${weight}kg\nFecha: ${entryDate}\nLote: ${lot}\nC√≥digo: ${code}`;
                qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrText)}`;
            }
            
            const productData = {
                name: pendingProductMove.productName,
                measure: pendingProductMove.productMeasure,
                weight: weight,
                entryDate: entryDate,
                lot: lot,
                code: code,
                qrUrl: qrUrl,
                id: `${pendingProductMove.productName}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
            };
            
            // Agregar producto a dep√≥sito
            if (!inventory[pendingProductMove.targetType]) {
                inventory[pendingProductMove.targetType] = [];
            }
            inventory[pendingProductMove.targetType].push(productData);
            
            // Guardar referencia antes de cancelar
            const isMultiple = pendingProductMove.isMultiple;
            
            // Si no es m√∫ltiple, eliminar de origen
            if (!isMultiple) {
                if (pendingProductMove.sourceType === 'transito') {
                    inventory.transito.splice(pendingProductMove.sourceIndex, 1);
                } else if (pendingProductMove.sourceType === 'pedidos') {
                    inventory.pedidos.splice(pendingProductMove.sourceIndex, 1);
                }
            }
            
            saveInventoryData(inventory);
            cancelProduct();
            
            // Si es m√∫ltiple, mostrar siguiente modal
            if (isMultiple) {
                currentMultipleIndex++;
                showNextMultipleProductModal();
            } else {
                // Actualizar vista solo si no es m√∫ltiple
                if (activeSection) {
                    showSectionDetail(activeSection);
                }
            }
        }

        function cancelProduct() {
            document.getElementById('productModal').style.display = 'none';
            document.getElementById('productWeight').value = '';
            document.getElementById('entryDate').value = '';
            document.getElementById('productLot').value = '';
            document.getElementById('generatedCode').textContent = '';
            document.getElementById('qrPreview').innerHTML = '';
            document.getElementById('downloadBtn').style.display = 'none';
            pendingProductMove = null;
        }

        // Funciones para el nuevo sistema de botones
        function addToPedidos(productName, productMeasure, category, index) {
            const quantity = parseInt(document.getElementById(`qty_${index}`).value) || 1;
            const inventory = getInventoryData();
            
            inventory.pedidos.push({ 
                name: productName, 
                measure: productMeasure,
                category: category || 'Sin categor√≠a',
                quantity: quantity,
                status: 'pendiente'
            });
            
            saveInventoryData(inventory);
            document.getElementById(`qty_${index}`).value = 1;
            
            if (activeSection === 'pedidos') {
                showSectionDetail('pedidos');
            }
        }

        function requestProduct(index) {
            const inventory = getInventoryData();
            const product = inventory.pedidos[index];
            const quantity = product.quantity || 1;
            
            // Asegurar que transito existe
            if (!inventory.transito) {
                inventory.transito = [];
            }
            
            // Eliminar producto original de pedidos
            inventory.pedidos.splice(index, 1);
            
            // Crear productos individuales en tr√°nsito seg√∫n la cantidad
            for (let i = 0; i < quantity; i++) {
                inventory.transito.push({
                    name: product.name,
                    measure: product.measure,
                    category: product.category,
                    quantity: 1,
                    status: 'en_transito'
                });
            }
            
            saveInventoryData(inventory);
            showSectionDetail('pedidos');
        }
        
        function deleteProduct(index) {
            const inventory = getInventoryData();
            const product = inventory.pedidos[index];
            
            if (!inventory.eliminados) inventory.eliminados = [];
            inventory.eliminados.push({...product, deletedFrom: 'pedidos'});
            inventory.pedidos.splice(index, 1);
            saveInventoryData(inventory);
            showSectionDetail('pedidos');
        }
        
        function deleteTransitProduct(index) {
            const inventory = getInventoryData();
            const product = inventory.transito[index];
            
            if (!inventory.eliminados) inventory.eliminados = [];
            inventory.eliminados.push({...product, deletedFrom: 'transito'});
            inventory.transito.splice(index, 1);
            saveInventoryData(inventory);
            showSectionDetail('transito');
        }
        
        function deleteDepositProduct(index) {
            const inventory = getInventoryData();
            const product = inventory.deposito[index];
            
            if (!inventory.eliminados) inventory.eliminados = [];
            inventory.eliminados.push({...product, deletedFrom: 'deposito'});
            inventory.deposito.splice(index, 1);
            saveInventoryData(inventory);
            showSectionDetail('deposito');
        }
        
        function reingresarProduct(index) {
            const inventory = getInventoryData();
            const product = inventory.eliminados[index];
            
            // Reingresar a pedidos (sin importar de d√≥nde vino)
            const newProduct = {
                name: product.name,
                measure: product.measure,
                category: product.category || 'Sin categor√≠a',
                quantity: product.quantity || 1,
                status: 'pendiente'
            };
            
            inventory.pedidos.push(newProduct);
            inventory.eliminados.splice(index, 1);
            saveInventoryData(inventory);
            showSectionDetail('eliminados');
        }
        
        function permanentDelete(index) {
            const inventory = getInventoryData();
            inventory.eliminados.splice(index, 1);
            saveInventoryData(inventory);
            showSectionDetail('eliminados');
        }
        
        function showProductDetails(index) {
            showProductDetailsModal(index, 'deposito');
        }
        
        function showProductDetailsModal(index, sectionType) {
            const inventory = getInventoryData();
            const product = inventory[sectionType][index];
            
            if (!product) return;
            
            const detailsModal = document.createElement('div');
            detailsModal.className = 'rejection-modal';
            detailsModal.style.display = 'block';
            
            // Calcular fecha de vencimiento (ejemplo: 6 meses desde ingreso)
            let expirationDate = 'No definido';
            if (product.entryDate) {
                const entry = new Date(product.entryDate);
                entry.setMonth(entry.getMonth() + 6);
                expirationDate = entry.toLocaleDateString('es-ES');
            }
            
            detailsModal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <h3>üìã Detalles Completos del Producto</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div>
                            <p><strong>üì¶ Producto:</strong> ${product.name}</p>
                            <p><strong>üìè Medida:</strong> ${product.measure || 'N/A'}</p>
                            <p><strong>‚öñÔ∏è Peso:</strong> ${product.weight || 'N/A'}kg</p>
                            <p><strong>üìÖ Fecha Ingreso:</strong> ${product.entryDate || 'N/A'}</p>
                        </div>
                        <div>
                            <p><strong>üè∑Ô∏è Lote:</strong> ${product.lot || 'N/A'}</p>
                            <p><strong>üî¢ C√≥digo:</strong> ${product.code || 'N/A'}</p>
                            <p><strong>‚è∞ Vencimiento:</strong> ${expirationDate}</p>
                            <p><strong>üìç Ubicaci√≥n:</strong> ${sectionType}</p>
                        </div>
                    </div>
                    ${product.qrUrl ? `
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                            <h4>üì± C√≥digo QR</h4>
                            <img src="${product.qrUrl}" alt="QR Code" style="border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                            <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                <strong>Informaci√≥n del QR:</strong><br>
                                ${product.name}<br>
                                Peso: ${product.weight || 'N/A'}kg | Fecha: ${product.entryDate || 'N/A'}<br>
                                Lote: ${product.lot || 'N/A'} | C√≥digo: ${product.code || 'N/A'}
                            </div>
                        </div>
                    ` : '<div style="text-align: center; padding: 20px; color: #999;">üì± No hay c√≥digo QR disponible</div>'}
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="modal-btn cancel" onclick="this.closest('.rejection-modal').remove()">Cerrar</button>
                        ${product.qrUrl ? `<button class="modal-btn" onclick="downloadProductQR('${product.name}', '${product.lot}', '${product.qrUrl}')">üì• Descargar QR</button>` : ''}
                    </div>
                </div>
            `;
            document.body.appendChild(detailsModal);
        }
        
        function downloadProductQR(productName, lot, qrUrl) {
            const link = document.createElement('a');
            link.download = `QR_${productName}_${lot}.png`;
            link.href = qrUrl;
            link.click();
        }

        let multipleProductQueue = [];
        let currentMultipleIndex = 0;
        
        function enterProduct(index) {
            const inventory = getInventoryData();
            const product = inventory.transito[index];
            const quantity = product.quantity || 1;
            
            if (quantity > 1) {
                // Configurar cola para m√∫ltiples productos
                multipleProductQueue = [];
                currentMultipleIndex = 0;
                
                for (let i = 0; i < quantity; i++) {
                    multipleProductQueue.push({
                        name: product.name,
                        measure: product.measure,
                        unitNumber: i + 1,
                        totalUnits: quantity
                    });
                }
                
                // Eliminar producto original de tr√°nsito
                inventory.transito.splice(index, 1);
                saveInventoryData(inventory);
                
                // Mostrar primer modal
                showNextMultipleProductModal();
            } else {
                // Una sola unidad - proceso normal
                pendingProductMove = {
                    productName: product.name,
                    productMeasure: product.measure,
                    sourceType: 'transito',
                    sourceIndex: index,
                    targetType: 'deposito',
                    isMultiple: false
                };
                showProductModal(product.name);
            }
        }
        
        function showNextMultipleProductModal() {
            if (currentMultipleIndex < multipleProductQueue.length) {
                const currentProduct = multipleProductQueue[currentMultipleIndex];
                
                pendingProductMove = {
                    productName: currentProduct.name,
                    productMeasure: currentProduct.measure,
                    sourceType: 'multiple',
                    targetType: 'deposito',
                    isMultiple: true,
                    unitNumber: currentProduct.unitNumber,
                    totalUnits: currentProduct.totalUnits
                };
                
                document.getElementById('modalProductName').textContent = 
                    `${currentProduct.name} (Unidad ${currentProduct.unitNumber} de ${currentProduct.totalUnits})`;
                
                showProductModal(currentProduct.name);
            } else {
                // Terminamos con todos los productos
                multipleProductQueue = [];
                currentMultipleIndex = 0;
                showSectionDetail('transito');
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const rejectionModal = document.getElementById('rejectionModal');
            const productModal = document.getElementById('productModal');
            if (event.target === rejectionModal) {
                cancelRejection();
            } else if (event.target === productModal) {
                cancelProduct();
            } else if (event.target.classList.contains('rejection-modal')) {
                event.target.remove();
            }
        }
    </script>
</body>
</html>