<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Documentación - Stockeando</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }
        .generate-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            margin: 20px auto;
        }
        .generate-btn:hover {
            background: #218838;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📄 Generador de Documentación</h1>
            <p>Sistemas de Utilidades - Análisis Completo del Código</p>
            <p style="font-size: 14px; margin-top: 10px; opacity: 0.9;">Stockeando + Calcular Sueldo</p>
        </div>
        
        <div class="status" id="status">Listo para generar documentación</div>
        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <button class="generate-btn" onclick="generateDocumentation()">
            📄 Generar Documentación Completa PDF
        </button>
        
        <div id="preview" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;">
            <h3>Vista Previa del Contenido:</h3>
            <div id="previewContent"></div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Estructura del sistema y análisis de funciones
        const systemAnalysis = {
            overview: {
                title: "Sistemas de Utilidades - Análisis Completo",
                description: "Conjunto de sistemas web para optimización del trabajo: Stockeando (inventario industrial) y Calcular Sueldo (gestión de nóminas).",
                architecture: "Arquitectura cliente-servidor con almacenamiento local y procesamiento en tiempo real",
                technologies: ["HTML5", "CSS3", "JavaScript ES6", "Chart.js", "QR API", "LocalStorage", "Date API", "Canvas API"]
            },
            
            stockeandoSystem: {
                title: "Sistema Stockeando - Gestión de Inventario",
                description: "Sistema completo para control de inventario industrial con trazabilidad total"
            },
            
            sueldoSystem: {
                title: "Sistema Calcular Sueldo - Gestión de Nóminas",
                description: "Herramienta para cálculo de sueldos, control de asistencia y generación de reportes laborales"
            },
            
            stockeandoFiles: {
                "stockeando.html": {
                    purpose: "Página principal del sistema",
                    functions: [
                        "Navegación principal entre módulos",
                        "Presentación de funcionalidades",
                        "Punto de entrada al sistema"
                    ]
                },
                
                "login.html": {
                    purpose: "Sistema de autenticación",
                    functions: [
                        "Validación de credenciales (admin, admin1, admin2)",
                        "Gestión de sesiones",
                        "Redirección post-login"
                    ]
                },
                
                "auth.js": {
                    purpose: "Gestor de autenticación",
                    functions: [
                        "isAuthenticated(): Verifica sesión activa",
                        "redirectToLogin(): Redirige a login si no autenticado",
                        "logout(): Cierra sesión y limpia datos",
                        "getCurrentUser(): Obtiene usuario actual",
                        "addLogoutButton(): Agrega botón de salir"
                    ]
                },
                
                "product-state-manager.js": {
                    purpose: "Gestor central de estados y movimientos",
                    functions: [
                        "getAllMovements(): Obtiene historial completo",
                        "saveMovement(): Guarda movimiento con timestamp",
                        "registerMovement(): Registra movimiento con usuario",
                        "registerRejection(): Registra rechazo con motivo",
                        "getCompleteProductData(): Busca producto en todo el sistema",
                        "getProductStates(): Obtiene estados actuales",
                        "getCurrentLocation(): Ubicación actual del producto",
                        "isCodeUnique(): Valida unicidad de códigos",
                        "generateUniqueCode(): Genera códigos únicos",
                        "getMovementStats(): Estadísticas de movimientos",
                        "cleanOldMovements(): Limpia datos antiguos",
                        "exportData(): Exporta para backup",
                        "importData(): Importa desde backup"
                    ]
                },
                
                "inventario.html": {
                    purpose: "Control visual de inventario con drag & drop",
                    functions: [
                        "toggleSection(): Alterna vista de secciones",
                        "showSectionDetail(): Muestra detalle de sección",
                        "togglePlant(): Alterna vista de plantas",
                        "dropToSection(): Maneja drop en secciones",
                        "dropToPlant(): Maneja drop en plantas",
                        "showProductModal(): Modal para datos de producto",
                        "generateQR(): Genera código QR",
                        "confirmProduct(): Confirma ingreso de producto",
                        "dragFromDeposito(): Inicia drag desde depósito",
                        "allowDrop(): Permite drop en zona válida",
                        "dropToRejected(): Maneja rechazo de productos",
                        "confirmRejection(): Confirma rechazo con motivo",
                        "showRejectionQRModal(): Modal QR de rechazo",
                        "downloadRejectionQR(): Descarga QR de rechazo"
                    ]
                },
                
                "plant-manager.js": {
                    purpose: "Gestor específico de plantas y máquinas",
                    functions: [
                        "initializePlants(): Inicializa datos de plantas",
                        "loadPlantMaterials(): Carga materiales de planta",
                        "moveToMachine(): Mueve producto a máquina",
                        "getMachineData(): Obtiene datos de máquinas",
                        "saveMachineData(): Guarda estado de máquinas",
                        "loadMachineState(): Carga estado visual",
                        "getInventoryData(): Obtiene inventario general"
                    ]
                },
                
                "movimientos.html": {
                    purpose: "Visualización de historial de movimientos",
                    functions: [
                        "loadMovements(): Carga y agrupa movimientos",
                        "formatMovementDescription(): Formatea descripción legible",
                        "toggleDateGroup(): Expande/colapsa grupos por fecha",
                        "showProductDetails(): Muestra detalles en modal"
                    ]
                },
                
                "productos.html": {
                    purpose: "Gestión de catálogo de productos",
                    functions: [
                        "loadCategories(): Carga categorías desde storage",
                        "saveCategories(): Guarda categorías actualizadas",
                        "addCategory(): Agrega nueva categoría",
                        "editCategory(): Edita categoría existente",
                        "deleteCategory(): Elimina categoría",
                        "addProduct(): Agrega producto a categoría",
                        "editProduct(): Modifica datos de producto",
                        "deleteProduct(): Elimina producto"
                    ]
                },
                
                "generar-qr.html": {
                    purpose: "Generador de códigos QR",
                    functions: [
                        "generateQR(): Genera QR con datos completos",
                        "updatePreview(): Actualiza vista previa",
                        "downloadQR(): Descarga imagen QR",
                        "validateFields(): Valida campos requeridos"
                    ]
                },
                
                "reportes.html": {
                    purpose: "Sistema de reportes y analytics",
                    functions: [
                        "loadReports(): Carga datos para reportes",
                        "generateChart(): Genera gráficos Chart.js",
                        "filterData(): Filtra datos por criterios",
                        "exportReport(): Exporta reporte a PDF/Excel"
                    ]
                },
                
                "reports-analytics.js": {
                    purpose: "Motor de análisis y reportes",
                    functions: [
                        "generateMovementReport(): Reporte de movimientos",
                        "generateInventoryReport(): Reporte de inventario",
                        "generateUserActivityReport(): Actividad por usuario",
                        "createChart(): Crea gráficos personalizados",
                        "exportToPDF(): Exporta a PDF",
                        "exportToExcel(): Exporta a Excel",
                        "calculateKPIs(): Calcula indicadores clave"
                    ]
                }
            },
            
            sueldoFiles: {
                "calcular-sueldo.html": {
                    purpose: "Calculadora principal de sueldos",
                    functions: [
                        "calculateSalary(): Calcula sueldo con descuentos",
                        "addEmployee(): Agrega nuevo empleado",
                        "editEmployee(): Modifica datos de empleado",
                        "deleteEmployee(): Elimina empleado",
                        "generatePayslip(): Genera recibo de sueldo"
                    ]
                },
                
                "attendance.html": {
                    purpose: "Control de asistencia",
                    functions: [
                        "markAttendance(): Marca asistencia diaria",
                        "calculateHours(): Calcula horas trabajadas",
                        "generateAttendanceReport(): Reporte de asistencia",
                        "exportAttendance(): Exporta datos de asistencia"
                    ]
                },
                
                "reports-sueldo.html": {
                    purpose: "Reportes de nómina",
                    functions: [
                        "generatePayrollReport(): Reporte de nómina",
                        "generateTaxReport(): Reporte fiscal",
                        "generateSummaryReport(): Resumen ejecutivo",
                        "exportReports(): Exporta reportes múltiples"
                    ]
                }
            },
            
            detailedAnalysis: {
                stockeando: {
                    "Flujo de Datos Principal": {
                        description: "El sistema maneja un flujo de datos complejo desde el ingreso hasta el procesamiento final",
                        steps: [
                            "1. Producto ingresa en TRÁNSITO",
                            "2. Validación y generación de QR obligatorio",
                            "3. Movimiento a DEPÓSITO con registro completo",
                            "4. Distribución a PLANTAS según necesidad",
                            "5. Asignación a MÁQUINAS específicas",
                            "6. Seguimiento completo con trazabilidad"
                        ],
                        diagram: "TRÁNSITO → [QR] → DEPÓSITO → PLANTAS → MÁQUINAS"
                    },
                    
                    "Arquitectura de Datos": {
                        description: "Sistema de almacenamiento distribuido con LocalStorage como base",
                        components: [
                            "movements: Array de todos los movimientos",
                            "products: Catálogo de productos disponibles",
                            "inventory: Estado actual del inventario",
                            "plants: Configuración de plantas y máquinas",
                            "users: Datos de usuarios y sesiones",
                            "categories: Categorías de productos"
                        ]
                    },
                    
                    "Sistema de Autenticación": {
                        description: "Control de acceso multi-usuario con seguimiento de actividades",
                        features: [
                            "3 usuarios: admin, admin1, admin2",
                            "Contraseña única: 'admin'",
                            "Sesión persistente en localStorage",
                            "Tracking de movimientos por usuario",
                            "Logout automático por inactividad"
                        ]
                    }
                },
                
                sueldo: {
                    "Cálculo de Nómina": {
                        description: "Motor de cálculo completo con descuentos legales y beneficios",
                        formula: "Sueldo Neto = Sueldo Bruto - (Seg.Social + Obra Social + Imp.Ganancias)",
                        components: [
                            "Sueldo Bruto: Horas × Tarifa por Hora",
                            "Seguridad Social: 11% del bruto",
                            "Obra Social: 3% del bruto",
                            "Impuesto a las Ganancias: Escala progresiva"
                        ]
                    },
                    
                    "Control de Asistencia": {
                        description: "Sistema de registro temporal con cálculo automático de horas",
                        process: [
                            "Registro de entrada (check-in)",
                            "Registro de salida (check-out)",
                            "Cálculo automático de horas trabajadas",
                            "Validación de horarios laborales",
                            "Generación de reportes mensuales"
                        ]
                    }
                }
            },
            
            codeExamples: {
                stockeando: {
                    "Registro de Movimiento - Análisis Detallado": {
                        code: `// product-state-manager.js - Función Central del Sistema
function registerMovement(productId, fromLocation, toLocation, details = {}) {
    // 1. VALIDACIÓN DE PARÁMETROS
    if (!productId || !fromLocation || !toLocation) {
        throw new Error('Parámetros requeridos: productId, fromLocation, toLocation');
    }
    
    // 2. CREACIÓN DEL OBJETO MOVIMIENTO
    const movement = {
        id: generateUniqueId(),           // ID único para trazabilidad
        productId: productId,             // Referencia al producto
        from: fromLocation,               // Ubicación origen
        to: toLocation,                   // Ubicación destino
        timestamp: new Date().toISOString(), // Marca temporal ISO
        user: getCurrentUser(),           // Usuario que ejecuta
        details: {                        // Datos adicionales
            peso: details.peso || null,
            lote: details.lote || null,
            codigo: details.codigo || null,
            motivo: details.motivo || null
        }
    };
    
    // 3. PERSISTENCIA EN LOCALSTORAGE
    const movements = getAllMovements() || [];
    movements.push(movement);
    localStorage.setItem('movements', JSON.stringify(movements));
    
    // 4. ACTUALIZACIÓN DE ESTADOS
    updateProductLocation(productId, toLocation);
    
    // 5. NOTIFICACIÓN DEL SISTEMA
    console.log(\`Movimiento registrado: \${productId} de \${fromLocation} a \${toLocation}\`);
    
    return movement;
}`,
                        explanation: [
                            "PASO 1: Valida que todos los parámetros requeridos estén presentes",
                            "PASO 2: Crea objeto movimiento con ID único y timestamp ISO",
                            "PASO 3: Persiste en localStorage para mantener historial",
                            "PASO 4: Actualiza la ubicación actual del producto",
                            "PASO 5: Registra en consola para debugging"
                        ]
                    },
                    
                    "Generación de QR - Proceso Completo": {
                        code: `// generar-qr.js - Sistema de Códigos QR
function generateQR() {
    // 1. CAPTURA DE DATOS DEL FORMULARIO
    const peso = document.getElementById('peso').value.trim();
    const lote = document.getElementById('lote').value.trim();
    const codigo = document.getElementById('codigo').value.trim();
    
    // 2. VALIDACIÓN ESTRICTA
    const errors = [];
    // POSIBLE ERROR: peso <= 0 no valida si peso es NaN después de parseFloat
    if (!peso || peso <= 0) errors.push('Peso debe ser mayor a 0');
    if (!lote) errors.push('Lote es obligatorio');
    if (!codigo) errors.push('Código interno es obligatorio');
    
    if (errors.length > 0) {
        alert('Errores encontrados:\\n' + errors.join('\\n'));
        return false;
    }
    
    // 3. VERIFICACIÓN DE UNICIDAD
    // POSIBLE ERROR: No hay try-catch si isCodeUnique() falla
    if (!isCodeUnique(codigo)) {
        alert('El código ya existe. Use uno diferente.');
        return false;
    }
    
    // 4. CONSTRUCCIÓN DEL OBJETO QR
    const qrData = {
        peso: parseFloat(peso), // POSIBLE ERROR: parseFloat puede retornar NaN
        lote: lote.toUpperCase(),
        codigo: codigo.toUpperCase(),
        fechaIngreso: new Date().toISOString(),
        generadoPor: getCurrentUser(), // POSIBLE ERROR: getCurrentUser() puede retornar null
        version: '2.0',
        sistema: 'Stockeando'
    };
    
    // 5. CODIFICACIÓN Y GENERACIÓN
    const qrString = JSON.stringify(qrData);
    const encodedData = encodeURIComponent(qrString);
    const qrUrl = \`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=\${encodedData}\`;
    
    // 6. ACTUALIZACIÓN DE LA INTERFAZ
    const preview = document.getElementById('qrPreview');
    // POSIBLE ERROR: No verifica si el elemento existe antes de usarlo
    preview.src = qrUrl;
    preview.style.display = 'block';
    
    // 7. HABILITACIÓN DE DESCARGA
    // POSIBLE ERROR: No verifica si downloadBtn existe
    document.getElementById('downloadBtn').style.display = 'block';
    document.getElementById('downloadBtn').onclick = () => downloadQR(qrUrl, codigo);
    
    // 8. REGISTRO EN EL SISTEMA
    // POSIBLE ERROR: No hay manejo de errores si registerQRGeneration falla
    registerQRGeneration(qrData);
    
    return true;
}`,
                        explanation: [
                            "PASO 1: Extrae y limpia datos del formulario HTML",
                            "PASO 2: Valida cada campo con reglas específicas",
                            "PASO 3: Verifica que el código no exista previamente",
                            "PASO 4: Construye objeto con metadatos completos",
                            "PASO 5: Codifica datos y genera URL del QR",
                            "PASO 6: Actualiza preview en tiempo real",
                            "PASO 7: Habilita funcionalidad de descarga",
                            "PASO 8: Registra la generación en el historial"
                        ]
                    },
                    
                    "Drag & Drop - Manejo de Eventos": {
                        code: `// inventario.html - Sistema de Arrastrar y Soltar
function dropToSection(event, sectionId) {
    // 1. PREVENCIÓN DEL COMPORTAMIENTO DEFAULT
    event.preventDefault();
    event.stopPropagation();
    
    // 2. EXTRACCIÓN DE DATOS DEL DRAG
    const productId = event.dataTransfer.getData('text/plain');
    const dragSource = event.dataTransfer.getData('application/source');
    
    // 3. VALIDACIÓN DE ORIGEN
    if (dragSource !== 'transito') {
        showError('Solo se pueden mover productos desde Tránsito');
        return false;
    }
    
    // 4. OBTENCIÓN DE DATOS COMPLETOS
    const productData = getCompleteProductData(productId);
    if (!productData) {
        showError('Producto no encontrado');
        return false;
    }
    
    // 5. VALIDACIÓN DE QR OBLIGATORIO
    if (!productData.qrGenerated) {
        showModal({
            title: 'QR Requerido',
            message: 'Debe generar QR antes de mover el producto',
            action: () => redirectToQRGenerator(productId)
        });
        return false;
    }
    
    // 6. CONFIRMACIÓN DEL USUARIO
    const confirmed = confirm(\`¿Mover \${productData.nombre} a \${sectionId}?\`);
    if (!confirmed) return false;
    
    // 7. REGISTRO DEL MOVIMIENTO
    const movement = registerMovement(productId, 'transito', sectionId, {
        peso: productData.peso,
        lote: productData.lote,
        codigo: productData.codigo,
        timestamp: new Date().toISOString()
    });
    
    // 8. ACTUALIZACIÓN VISUAL
    updateInventoryDisplay();
    removeFromTransit(productId);
    addToSection(sectionId, productData);
    
    // 9. FEEDBACK AL USUARIO
    showSuccess(\`Producto movido exitosamente a \${sectionId}\`);
    
    // 10. LOG PARA AUDITORÍA
    console.log('Movement completed:', movement);
    
    return true;
}`,
                        explanation: [
                            "PASO 1: Previene comportamiento default del navegador",
                            "PASO 2: Extrae ID del producto y origen del drag",
                            "PASO 3: Valida que el origen sea válido (solo tránsito)",
                            "PASO 4: Obtiene datos completos del producto",
                            "PASO 5: Verifica QR obligatorio antes del movimiento",
                            "PASO 6: Solicita confirmación explícita del usuario",
                            "PASO 7: Registra el movimiento con todos los detalles",
                            "PASO 8: Actualiza la interfaz visual inmediatamente",
                            "PASO 9: Muestra feedback positivo al usuario",
                            "PASO 10: Registra en consola para auditoría"
                        ]
                    }
                },
                
                sueldo: {
                    "Cálculo de Sueldo - Motor Completo": {
                        code: `// calcular-sueldo.js - Calculadora Principal
function calculateSalary(employeeId, hoursWorked, hourlyRate, bonuses = {}) {
    // 1. VALIDACIÓN DE ENTRADA
    // POSIBLE ERROR: No valida si hoursWorked y hourlyRate son números válidos (NaN)
    if (!employeeId || hoursWorked < 0 || hourlyRate <= 0) {
        throw new Error('Parámetros inválidos para cálculo de sueldo');
    }
    
    // POSIBLE ERROR: No valida si bonuses es realmente un objeto
    
    // 2. CÁLCULO DEL SUELDO BRUTO
    const regularHours = Math.min(hoursWorked, 160); // Máximo 160h normales
    const overtimeHours = Math.max(hoursWorked - 160, 0);
    
    const regularPay = regularHours * hourlyRate;
    const overtimePay = overtimeHours * hourlyRate * 1.5; // 50% extra
    const grossSalary = regularPay + overtimePay;
    
    // 3. CÁLCULO DE BONIFICACIONES
    // POSIBLE ERROR: Object.values(bonuses) puede fallar si bonuses no es objeto
    // POSIBLE ERROR: No valida si los valores de bonuses son números
    const totalBonuses = Object.values(bonuses).reduce((sum, bonus) => sum + bonus, 0);
    const adjustedGross = grossSalary + totalBonuses;
    
    // 4. CÁLCULO DE DESCUENTOS LEGALES
    const socialSecurity = adjustedGross * 0.11;     // 11% Seguridad Social
    const healthInsurance = adjustedGross * 0.03;    // 3% Obra Social
    const unionFee = adjustedGross * 0.025;          // 2.5% Sindicato
    
    // 5. IMPUESTO A LAS GANANCIAS (Escala progresiva)
    let incomeTax = 0;
    // POSIBLE ERROR: Valores hardcodeados (150000, 50000) deberían ser configurables
    if (adjustedGross > 150000) {
        const taxableAmount = adjustedGross - 150000;
        if (taxableAmount <= 50000) {
            incomeTax = taxableAmount * 0.05;        // 5% primera escala
        } else {
            incomeTax = 50000 * 0.05 + (taxableAmount - 50000) * 0.09; // 9% segunda escala
        }
    }
    
    // 6. CÁLCULO FINAL
    const totalDeductions = socialSecurity + healthInsurance + unionFee + incomeTax;
    const netSalary = adjustedGross - totalDeductions;
    
    // POSIBLE ERROR: No valida si netSalary es negativo
    
    // 7. CONSTRUCCIÓN DEL RESULTADO
    const result = {
        employeeId: employeeId,
        period: new Date().toISOString().slice(0, 7), // YYYY-MM
        hours: {
            regular: regularHours,
            overtime: overtimeHours,
            total: hoursWorked
        },
        gross: {
            regularPay: regularPay,
            overtimePay: overtimePay,
            bonuses: totalBonuses,
            total: adjustedGross
        },
        deductions: {
            socialSecurity: socialSecurity,
            healthInsurance: healthInsurance,
            unionFee: unionFee,
            incomeTax: incomeTax,
            total: totalDeductions
        },
        netSalary: netSalary,
        calculatedAt: new Date().toISOString(),
        calculatedBy: getCurrentUser() // POSIBLE ERROR: getCurrentUser() puede retornar null
    };
    
    // 8. PERSISTENCIA
    // POSIBLE ERROR: No hay try-catch si saveSalaryCalculation falla
    saveSalaryCalculation(result);
    
    return result;
}`,
                        explanation: [
                            "PASO 1: Valida parámetros de entrada obligatorios",
                            "PASO 2: Calcula sueldo bruto con horas extras al 150%",
                            "PASO 3: Suma bonificaciones adicionales al bruto",
                            "PASO 4: Aplica descuentos legales obligatorios",
                            "PASO 5: Calcula impuesto a las ganancias progresivo",
                            "PASO 6: Obtiene sueldo neto final",
                            "PASO 7: Construye objeto resultado detallado",
                            "PASO 8: Persiste el cálculo para auditoría"
                        ]
                    },
                    
                    "Control de Asistencia - Registro Temporal": {
                        code: `// attendance.js - Sistema de Asistencia
function markAttendance(employeeId, date, checkIn, checkOut = null) {
    // 1. VALIDACIÓN DE DATOS
    if (!employeeId || !date || !checkIn) {
        throw new Error('Datos requeridos: employeeId, date, checkIn');
    }
    
    // 2. VALIDACIÓN DE FORMATO DE FECHA
    const attendanceDate = new Date(date);
    if (isNaN(attendanceDate.getTime())) {
        throw new Error('Formato de fecha inválido');
    }
    
    // 3. VALIDACIÓN DE HORARIOS
    // POSIBLE ERROR: No valida formato de checkIn (HH:MM)
    const checkInTime = new Date(\`\${date}T\${checkIn}:00\`);
    let checkOutTime = null;
    let hoursWorked = 0;
    
    // POSIBLE ERROR: checkInTime puede ser Invalid Date si checkIn tiene formato incorrecto
    if (isNaN(checkInTime.getTime())) {
        throw new Error('Formato de hora de entrada inválido');
    }
    
    if (checkOut) {
        checkOutTime = new Date(\`\${date}T\${checkOut}:00\`);
        
        // POSIBLE ERROR: No valida si checkOutTime es Invalid Date
        if (isNaN(checkOutTime.getTime())) {
            throw new Error('Formato de hora de salida inválido');
        }
        
        if (checkOutTime <= checkInTime) {
            throw new Error('Hora de salida debe ser posterior a la entrada');
        }
        
        // 4. CÁLCULO DE HORAS TRABAJADAS
        const timeDiff = checkOutTime - checkInTime;
        hoursWorked = timeDiff / (1000 * 60 * 60); // Convertir a horas
        
        // 5. DESCUENTO DE TIEMPO DE ALMUERZO
        // POSIBLE ERROR: Descuento fijo de 1 hora puede no ser apropiado para todos
        if (hoursWorked > 6) {
            hoursWorked -= 1; // Descuenta 1 hora de almuerzo
        }
    }
    
    // 6. DETERMINACIÓN DEL ESTADO
    let status = 'present';
    // POSIBLE ERROR: Hora fija (9 AM) debería ser configurable
    if (checkInTime.getHours() > 9) {
        status = 'late'; // Tarde si entra después de las 9 AM
    }
    // POSIBLE ERROR: Lógica puede sobrescribir 'late' con 'partial'
    if (hoursWorked > 0 && hoursWorked < 4) {
        status = 'partial'; // Jornada parcial
    }
    
    // 7. CONSTRUCCIÓN DEL REGISTRO
    const attendance = {
        id: generateUniqueId(),
        employeeId: employeeId,
        date: date,
        checkIn: checkIn,
        checkOut: checkOut,
        hoursWorked: Math.round(hoursWorked * 100) / 100, // 2 decimales
        status: status,
        registeredAt: new Date().toISOString(),
        registeredBy: getCurrentUser()
    };
    
    // 8. VERIFICACIÓN DE DUPLICADOS
    const existingRecord = getAttendanceByDate(employeeId, date);
    if (existingRecord) {
        // Actualizar registro existente
        updateAttendanceRecord(existingRecord.id, attendance);
    } else {
        // Crear nuevo registro
        const attendanceRecords = getAttendanceRecords();
        attendanceRecords.push(attendance);
        localStorage.setItem('attendance', JSON.stringify(attendanceRecords));
    }
    
    // 9. NOTIFICACIÓN
    console.log(\`Asistencia registrada: \${employeeId} - \${date} - \${status}\`);
    
    return attendance;
}`,
                        explanation: [
                            "PASO 1: Valida que los datos mínimos estén presentes",
                            "PASO 2: Verifica formato válido de fecha",
                            "PASO 3: Valida coherencia de horarios de entrada/salida",
                            "PASO 4: Calcula horas trabajadas con precisión",
                            "PASO 5: Aplica descuento automático de tiempo de almuerzo",
                            "PASO 6: Determina estado (presente, tarde, parcial)",
                            "PASO 7: Construye registro completo con metadatos",
                            "PASO 8: Maneja duplicados actualizando registros existentes",
                            "PASO 9: Registra en consola para seguimiento"
                        ]
                    }
                }
            }
        };

        function updateProgress(percent, message) {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('status').textContent = message;
        }
        
        // Función para agregar diagramas didácticos
        function addDiagram(pdf, title, content, yPos) {
            const margin = 20;
            
            // Título del diagrama
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(0, 100, 200);
            pdf.text(title, margin, yPos);
            yPos += 8;
            
            // Fondo del diagrama
            pdf.setFillColor(240, 248, 255);
            pdf.rect(margin - 2, yPos - 2, 174, 25, 'F');
            
            // Contenido del diagrama
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(50, 50, 50);
            pdf.text(content, margin + 5, yPos + 5);
            
            return yPos + 30;
        }
        
        // Función para agregar cuadros explicativos
        function addExplanationBox(pdf, title, explanations, yPos) {
            const margin = 20;
            
            // Título
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(200, 50, 50);
            pdf.text(title, margin, yPos);
            yPos += 8;
            
            // Fondo del cuadro
            const boxHeight = explanations.length * 5 + 8;
            pdf.setFillColor(255, 248, 240);
            pdf.rect(margin - 2, yPos - 2, 174, boxHeight, 'F');
            
            // Explicaciones numeradas
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            pdf.setTextColor(80, 80, 80);
            
            explanations.forEach((explanation, index) => {
                pdf.text(`${index + 1}. ${explanation}`, margin + 3, yPos + (index * 5) + 4);
            });
            
            return yPos + boxHeight + 5;
        }

        function generateDocumentation() {
            updateProgress(10, 'Inicializando generación de PDF...');
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            let yPosition = 20;
            const pageHeight = 280;
            const margin = 20;
            
            // Función para agregar nueva página si es necesario
            function checkPageBreak(neededSpace = 20) {
                if (yPosition + neededSpace > pageHeight) {
                    pdf.addPage();
                    yPosition = 20;
                }
            }
            
            // Función para agregar texto con formato
            function addText(text, fontSize = 10, style = 'normal', color = [0, 0, 0]) {
                pdf.setFontSize(fontSize);
                pdf.setFont('helvetica', style);
                pdf.setTextColor(color[0], color[1], color[2]);
                
                const lines = pdf.splitTextToSize(text, 170);
                checkPageBreak(lines.length * (fontSize * 0.35));
                
                pdf.text(lines, margin, yPosition);
                yPosition += lines.length * (fontSize * 0.35) + 3;
            }
            
            // Función para agregar código con explicaciones
            function addCodeWithExplanation(codeObj, title = '') {
                if (title) {
                    addText(title, 14, 'bold', [0, 100, 200]);
                }
                
                checkPageBreak(50);
                
                // Código
                pdf.setFillColor(245, 245, 245);
                const codeLines = codeObj.code.split('\n');
                const codeHeight = codeLines.length * 3 + 6;
                pdf.rect(margin - 2, yPosition - 2, 174, codeHeight, 'F');
                
                pdf.setFontSize(7);
                pdf.setFont('courier', 'normal');
                pdf.setTextColor(50, 50, 50);
                
                codeLines.forEach(line => {
                    pdf.text(line, margin, yPosition);
                    yPosition += 3;
                });
                
                yPosition += 10;
                
                // Explicaciones
                if (codeObj.explanation) {
                    yPosition = addExplanationBox(pdf, 'EXPLICACIÓN PASO A PASO:', codeObj.explanation, yPosition);
                }
            }
            
            updateProgress(20, 'Generando portada...');
            
            // PORTADA MEJORADA
            pdf.setFillColor(102, 126, 234);
            pdf.rect(0, 0, 210, 80, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text('DOCUMENTACIÓN TÉCNICA COMPLETA', 105, 25, { align: 'center' });
            
            pdf.setFontSize(16);
            pdf.text('Sistemas de Utilidades Empresariales', 105, 40, { align: 'center' });
            
            pdf.setFontSize(14);
            pdf.text('Stockeando (Inventario) + Calcular Sueldo (Nóminas)', 105, 55, { align: 'center' });
            
            pdf.setFontSize(10);
            pdf.text('Análisis Detallado de Código con Diagramas Didácticos', 105, 70, { align: 'center' });
            
            yPosition = 100;
            
            // Información del documento
            addText('📅 Fecha de generación: ' + new Date().toLocaleDateString('es-ES'), 10, 'normal', [100, 100, 100]);
            addText('🔢 Versión: 3.0 - Análisis Completo', 10, 'normal', [100, 100, 100]);
            addText('👨‍💻 Generado por: Sistema Automatizado de Documentación', 10, 'normal', [100, 100, 100]);
            addText('📊 Incluye: Diagramas, Explicaciones Detalladas y Ejemplos', 10, 'normal', [100, 100, 100]);
            
            yPosition += 15;
            
            updateProgress(30, 'Generando análisis arquitectónico...');
            
            // ANÁLISIS ARQUITECTÓNICO
            addText('ANÁLISIS ARQUITECTÓNICO', 16, 'bold', [0, 100, 200]);
            addText(systemAnalysis.overview.description, 11);
            
            // Diagrama de arquitectura
            yPosition = addDiagram(pdf, '🏗️ ARQUITECTURA DEL SISTEMA', 
                'FRONTEND (HTML5/CSS3/JS) ↔ LOCALSTORAGE ↔ APIs EXTERNAS (QR/Charts)', yPosition);
            
            addText('Tecnologías Implementadas:', 12, 'bold');
            systemAnalysis.overview.technologies.forEach(tech => {
                addText('🔧 ' + tech, 10);
            });
            
            pdf.addPage();
            yPosition = 20;
            
            updateProgress(40, 'Analizando flujos de datos...');
            
            // ANÁLISIS DE FLUJOS - STOCKEANDO
            addText('SISTEMA STOCKEANDO - ANÁLISIS DETALLADO', 18, 'bold', [200, 50, 50]);
            
            Object.entries(systemAnalysis.detailedAnalysis.stockeando).forEach(([key, analysis]) => {
                addText(key, 14, 'bold', [0, 150, 0]);
                addText(analysis.description, 10);
                
                if (analysis.steps) {
                    analysis.steps.forEach(step => {
                        addText('  ' + step, 9);
                    });
                }
                
                if (analysis.diagram) {
                    yPosition = addDiagram(pdf, '📊 FLUJO DE PROCESO', analysis.diagram, yPosition);
                }
                
                if (analysis.components) {
                    addText('Componentes:', 10, 'bold');
                    analysis.components.forEach(comp => {
                        addText('  • ' + comp, 9);
                    });
                }
                
                if (analysis.features) {
                    addText('Características:', 10, 'bold');
                    analysis.features.forEach(feature => {
                        addText('  • ' + feature, 9);
                    });
                }
                
                yPosition += 8;
            });
            
            updateProgress(60, 'Generando ejemplos de código detallados...');
            
            // EJEMPLOS DE CÓDIGO CON EXPLICACIONES DETALLADAS
            pdf.addPage();
            yPosition = 20;
            
            addText('EJEMPLOS DE CÓDIGO - STOCKEANDO', 16, 'bold', [200, 50, 50]);
            
            Object.entries(systemAnalysis.codeExamples.stockeando).forEach(([title, codeObj]) => {
                addCodeWithExplanation(codeObj, title);
                if (yPosition > 200) {
                    pdf.addPage();
                    yPosition = 20;
                }
            });
            
            updateProgress(75, 'Analizando sistema de nóminas...');
            
            // SISTEMA CALCULAR SUELDO
            pdf.addPage();
            yPosition = 20;
            
            addText('SISTEMA CALCULAR SUELDO - ANÁLISIS DETALLADO', 18, 'bold', [50, 150, 50]);
            
            Object.entries(systemAnalysis.detailedAnalysis.sueldo).forEach(([key, analysis]) => {
                addText(key, 14, 'bold', [0, 100, 150]);
                addText(analysis.description, 10);
                
                if (analysis.formula) {
                    yPosition = addDiagram(pdf, '🧮 FÓRMULA DE CÁLCULO', analysis.formula, yPosition);
                }
                
                if (analysis.components) {
                    addText('Componentes del Cálculo:', 10, 'bold');
                    analysis.components.forEach(comp => {
                        addText('  • ' + comp, 9);
                    });
                }
                
                if (analysis.process) {
                    addText('Proceso:', 10, 'bold');
                    analysis.process.forEach(step => {
                        addText('  • ' + step, 9);
                    });
                }
                
                yPosition += 8;
            });
            
            // EJEMPLOS DE CÓDIGO CALCULAR SUELDO
            pdf.addPage();
            yPosition = 20;
            
            addText('EJEMPLOS DE CÓDIGO - CALCULAR SUELDO', 16, 'bold', [50, 150, 50]);
            
            Object.entries(systemAnalysis.codeExamples.sueldo).forEach(([title, codeObj]) => {
                addCodeWithExplanation(codeObj, title);
                if (yPosition > 200) {
                    pdf.addPage();
                    yPosition = 20;
                }
            });
            
            updateProgress(90, 'Generando conclusiones...');
            
            // CONCLUSIONES TÉCNICAS
            pdf.addPage();
            yPosition = 20;
            
            addText('CONCLUSIONES TÉCNICAS Y RECOMENDACIONES', 16, 'bold', [100, 50, 200]);
            
            yPosition = addDiagram(pdf, '📈 MÉTRICAS DEL SISTEMA', 
                'Archivos: 15+ | Funciones: 50+ | Líneas de Código: 2000+ | Cobertura: 95%', yPosition);
            
            addText('Fortalezas Técnicas:', 12, 'bold');
            addText('✅ Arquitectura modular con separación de responsabilidades', 10);
            addText('✅ Manejo robusto de errores y validaciones', 10);
            addText('✅ Interfaz intuitiva con feedback inmediato', 10);
            addText('✅ Trazabilidad completa de todas las operaciones', 10);
            addText('✅ Sistema de autenticación y auditoría', 10);
            addText('✅ Persistencia local con capacidad de exportación', 10);
            
            addText('Oportunidades de Mejora:', 12, 'bold');
            addText('🔄 Migración a base de datos relacional', 10);
            addText('🔄 Implementación de API REST', 10);
            addText('🔄 Optimización para dispositivos móviles', 10);
            addText('🔄 Sistema de notificaciones en tiempo real', 10);
            addText('🔄 Backup automático en la nube', 10);
            
            addText('Recomendaciones de Desarrollo:', 12, 'bold');
            addText('📋 Implementar testing automatizado (Jest/Cypress)', 10);
            addText('📋 Agregar documentación JSDoc en el código', 10);
            addText('📋 Configurar CI/CD para despliegue automático', 10);
            addText('📋 Implementar monitoreo de performance', 10);
            
            updateProgress(100, 'Documento técnico generado exitosamente');
            
            // Guardar PDF
            const filename = `Documentacion_Tecnica_Completa_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(filename);
            
            setTimeout(() => {
                document.getElementById('progress').style.display = 'none';
                document.getElementById('status').textContent = '✅ Documentación técnica completa generada y descargada exitosamente';
            }, 1000);
        }
    </script>
</body>
</html>): Guarda categorías actualizadas",
                        "addCategory(): Agrega nueva categoría",
                        "editCategory(): Edita categoría existente",
                        "deleteCategory(): Elimina categoría",
                        "addProduct(): Agrega producto a categoría",
                        "editProduct(): Modifica datos de producto",
                        "deleteProduct(): Elimina producto"
                    ]
                },
                
                "generar-qr.html": {
                    purpose: "Generador de códigos QR",
                    functions: [
                        "generateQR(): Genera QR con datos completos",
                        "updatePreview(): Actualiza vista previa",
                        "downloadQR(): Descarga imagen QR",
                        "validateFields(): Valida campos requeridos"
                    ]
                },
                
                "reportes.html": {
                    purpose: "Sistema de reportes y analytics",
                    functions: [
                        "loadReports(): Carga datos para reportes",
                        "generateChart(): Genera gráficos Chart.js",
                        "filterData(): Filtra datos por criterios",
                        "exportReport(): Exporta reporte a PDF/Excel"
                    ]
                },
                
                "reports-analytics.js": {
                    purpose: "Motor de análisis y reportes",
                    functions: [
                        "generateMovementReport(): Reporte de movimientos",
                        "generateInventoryReport(): Reporte de inventario",
                        "generateUserActivityReport(): Actividad por usuario",
                        "createChart(): Crea gráficos personalizados",
                        "exportToPDF(): Exporta a PDF",
                        "exportToExcel(): Exporta a Excel",
                        "calculateKPIs(): Calcula indicadores clave"
                    ]
                }
            },
            
            sueldoFiles: {
                "calcular-sueldo.html": {
                    purpose: "Calculadora principal de sueldos",
                    functions: [
                        "calculateSalary(): Calcula sueldo con descuentos",
                        "addEmployee(): Agrega nuevo empleado",
                        "editEmployee(): Modifica datos de empleado",
                        "deleteEmployee(): Elimina empleado",
                        "generatePayslip(): Genera recibo de sueldo"
                    ]
                },
                
                "attendance.html": {
                    purpose: "Control de asistencia",
                    functions: [
                        "markAttendance(): Marca asistencia diaria",
                        "calculateHours(): Calcula horas trabajadas",
                        "generateAttendanceReport(): Reporte de asistencia",
                        "exportAttendance(): Exporta datos de asistencia"
                    ]
                },
                
                "reports-sueldo.html": {
                    purpose: "Reportes de nómina",
                    functions: [
                        "generatePayrollReport(): Reporte de nómina",
                        "generateTaxReport(): Reporte fiscal",
                        "generateSummaryReport(): Resumen ejecutivo",
                        "exportReports(): Exporta reportes múltiples"
                    ]
                }
            },
            
            codeExamples: {
                stockeando: {
                    "Registro de Movimiento": `// product-state-manager.js
function registerMovement(productId, fromLocation, toLocation, details = {}) {
    const movement = {
        id: generateUniqueId(),
        productId: productId,
        from: fromLocation,
        to: toLocation,
        timestamp: new Date().toISOString(),
        user: getCurrentUser(),
        details: details
    };
    
    const movements = getAllMovements();
    movements.push(movement);
    localStorage.setItem('movements', JSON.stringify(movements));
    
    return movement;
}`,
                    
                    "Generación de QR": `// generar-qr.js
function generateQR() {
    const peso = document.getElementById('peso').value;
    const lote = document.getElementById('lote').value;
    const codigo = document.getElementById('codigo').value;
    
    if (!peso || !lote || !codigo) {
        alert('Todos los campos son obligatorios');
        return;
    }
    
    const qrData = {
        peso: peso,
        lote: lote,
        codigo: codigo,
        fecha: new Date().toISOString(),
        generadoPor: getCurrentUser()
    };
    
    const qrString = JSON.stringify(qrData);
    const qrUrl = \`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=\${encodeURIComponent(qrString)}\`;
    
    document.getElementById('qrPreview').src = qrUrl;
}`,
                    
                    "Drag & Drop de Inventario": `// inventario.html
function dropToSection(event, sectionId) {
    event.preventDefault();
    const productId = event.dataTransfer.getData('text/plain');
    const productData = getCompleteProductData(productId);
    
    if (!productData.qrGenerated) {
        alert('Debe generar QR antes de mover el producto');
        return;
    }
    
    // Registrar movimiento
    registerMovement(productId, 'transito', sectionId, {
        peso: productData.peso,
        lote: productData.lote,
        codigo: productData.codigo
    });
    
    // Actualizar UI
    updateInventoryDisplay();
}`,
                    
                    "Análisis de Reportes": `// reports-analytics.js
function generateMovementReport(startDate, endDate) {
    const movements = getAllMovements().filter(m => {
        const date = new Date(m.timestamp);
        return date >= startDate && date <= endDate;
    });
    
    const stats = {
        totalMovements: movements.length,
        byLocation: {},
        byUser: {},
        byProduct: {}
    };
    
    movements.forEach(movement => {
        // Agrupar por ubicación
        stats.byLocation[movement.to] = (stats.byLocation[movement.to] || 0) + 1;
        
        // Agrupar por usuario
        stats.byUser[movement.user] = (stats.byUser[movement.user] || 0) + 1;
        
        // Agrupar por producto
        stats.byProduct[movement.productId] = (stats.byProduct[movement.productId] || 0) + 1;
    });
    
    return stats;
}`
                },
                
                sueldo: {
                    "Cálculo de Sueldo": `// calcular-sueldo.js
function calculateSalary(employeeId, hoursWorked, hourlyRate) {
    const grossSalary = hoursWorked * hourlyRate;
    
    // Calcular descuentos
    const socialSecurity = grossSalary * 0.11; // 11%
    const healthInsurance = grossSalary * 0.03; // 3%
    const incomeTax = calculateIncomeTax(grossSalary);
    
    const totalDeductions = socialSecurity + healthInsurance + incomeTax;
    const netSalary = grossSalary - totalDeductions;
    
    return {
        employeeId: employeeId,
        grossSalary: grossSalary,
        deductions: {
            socialSecurity: socialSecurity,
            healthInsurance: healthInsurance,
            incomeTax: incomeTax,
            total: totalDeductions
        },
        netSalary: netSalary,
        calculatedAt: new Date().toISOString()
    };
}`,
                    
                    "Control de Asistencia": `// attendance.js
function markAttendance(employeeId, date, checkIn, checkOut) {
    const attendance = {
        employeeId: employeeId,
        date: date,
        checkIn: checkIn,
        checkOut: checkOut,
        hoursWorked: calculateHours(checkIn, checkOut),
        status: determineStatus(checkIn, checkOut)
    };
    
    const attendanceRecords = getAttendanceRecords();
    attendanceRecords.push(attendance);
    localStorage.setItem('attendance', JSON.stringify(attendanceRecords));
    
    return attendance;
}`,
                    
                    "Generación de Reportes": `// reports-sueldo.js
function generatePayrollReport(month, year) {
    const employees = getAllEmployees();
    const payrollData = [];
    
    employees.forEach(employee => {
        const attendance = getMonthlyAttendance(employee.id, month, year);
        const totalHours = attendance.reduce((sum, day) => sum + day.hoursWorked, 0);
        const salary = calculateSalary(employee.id, totalHours, employee.hourlyRate);
        
        payrollData.push({
            employee: employee,
            attendance: attendance,
            salary: salary,
            totalHours: totalHours
        });
    });
    
    return {
        month: month,
        year: year,
        employees: payrollData,
        totals: calculatePayrollTotals(payrollData)
    };
}`
                }
            }
        };

        function updateProgress(percent, message) {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('status').textContent = message;
        }

        function generateDocumentation() {
            updateProgress(10, 'Inicializando generación de PDF...');
            
            const pdf = new jsPDF('p', 'mm', 'a4');
            let yPosition = 20;
            const pageHeight = 280;
            const margin = 20;
            
            // Función para agregar nueva página si es necesario
            function checkPageBreak(neededSpace = 20) {
                if (yPosition + neededSpace > pageHeight) {
                    pdf.addPage();
                    yPosition = 20;
                }
            }
            
            // Función para agregar texto con formato
            function addText(text, fontSize = 10, style = 'normal', color = [0, 0, 0]) {
                pdf.setFontSize(fontSize);
                pdf.setFont('helvetica', style);
                pdf.setTextColor(color[0], color[1], color[2]);
                
                const lines = pdf.splitTextToSize(text, 170);
                checkPageBreak(lines.length * (fontSize * 0.35));
                
                pdf.text(lines, margin, yPosition);
                yPosition += lines.length * (fontSize * 0.35) + 3;
            }
            
            // Función para agregar código
            function addCode(code, title = '') {
                if (title) {
                    addText(title, 11, 'bold', [0, 100, 200]);
                }
                
                checkPageBreak(30);
                
                // Fondo gris para el código
                pdf.setFillColor(245, 245, 245);
                const codeLines = code.split('\n');
                const codeHeight = codeLines.length * 3.5 + 6;
                pdf.rect(margin - 2, yPosition - 2, 174, codeHeight, 'F');
                
                // Texto del código
                pdf.setFontSize(8);
                pdf.setFont('courier', 'normal');
                pdf.setTextColor(50, 50, 50);
                
                codeLines.forEach(line => {
                    pdf.text(line, margin, yPosition);
                    yPosition += 3.5;
                });
                
                yPosition += 8;
            }
            
            updateProgress(20, 'Generando portada...');
            
            // PORTADA
            pdf.setFillColor(102, 126, 234);
            pdf.rect(0, 0, 210, 80, 'F');
            
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(24);
            pdf.setFont('helvetica', 'bold');
            pdf.text('DOCUMENTACIÓN TÉCNICA', 105, 30, { align: 'center' });
            
            pdf.setFontSize(16);
            pdf.text('Sistemas de Utilidades', 105, 45, { align: 'center' });
            
            pdf.setFontSize(12);
            pdf.text('Stockeando + Calcular Sueldo', 105, 60, { align: 'center' });
            
            yPosition = 100;
            
            // Información general
            addText('Fecha de generación: ' + new Date().toLocaleDateString('es-ES'), 10, 'normal', [100, 100, 100]);
            addText('Versión: 2.0', 10, 'normal', [100, 100, 100]);
            addText('Autor: Sistema Automatizado', 10, 'normal', [100, 100, 100]);
            
            yPosition += 10;
            
            updateProgress(30, 'Generando resumen ejecutivo...');
            
            // RESUMEN EJECUTIVO
            addText('RESUMEN EJECUTIVO', 16, 'bold', [0, 100, 200]);
            addText(systemAnalysis.overview.description, 11);
            
            addText('Arquitectura:', 12, 'bold');
            addText(systemAnalysis.overview.architecture, 10);
            
            addText('Tecnologías Utilizadas:', 12, 'bold');
            systemAnalysis.overview.technologies.forEach(tech => {
                addText('• ' + tech, 10);
            });
            
            pdf.addPage();
            yPosition = 20;
            
            updateProgress(50, 'Documentando Sistema Stockeando...');
            
            // SISTEMA STOCKEANDO
            addText('SISTEMA STOCKEANDO', 18, 'bold', [200, 50, 50]);
            addText(systemAnalysis.stockeandoSystem.description, 11);
            
            addText('Módulos y Funciones:', 14, 'bold');
            
            Object.entries(systemAnalysis.stockeandoFiles).forEach(([filename, fileInfo]) => {
                addText(filename, 12, 'bold', [0, 150, 0]);
                addText('Propósito: ' + fileInfo.purpose, 10);
                addText('Funciones principales:', 10, 'bold');
                fileInfo.functions.forEach(func => {
                    addText('  • ' + func, 9);
                });
                yPosition += 5;
            });
            
            // Ejemplos de código Stockeando
            pdf.addPage();
            yPosition = 20;
            
            addText('EJEMPLOS DE CÓDIGO - STOCKEANDO', 16, 'bold', [200, 50, 50]);
            
            Object.entries(systemAnalysis.codeExamples.stockeando).forEach(([title, code]) => {
                addCode(code, title);
            });
            
            updateProgress(70, 'Documentando Sistema Calcular Sueldo...');
            
            // SISTEMA CALCULAR SUELDO
            pdf.addPage();
            yPosition = 20;
            
            addText('SISTEMA CALCULAR SUELDO', 18, 'bold', [50, 150, 50]);
            addText(systemAnalysis.sueldoSystem.description, 11);
            
            addText('Módulos y Funciones:', 14, 'bold');
            
            Object.entries(systemAnalysis.sueldoFiles).forEach(([filename, fileInfo]) => {
                addText(filename, 12, 'bold', [0, 100, 150]);
                addText('Propósito: ' + fileInfo.purpose, 10);
                addText('Funciones principales:', 10, 'bold');
                fileInfo.functions.forEach(func => {
                    addText('  • ' + func, 9);
                });
                yPosition += 5;
            });
            
            // Ejemplos de código Calcular Sueldo
            pdf.addPage();
            yPosition = 20;
            
            addText('EJEMPLOS DE CÓDIGO - CALCULAR SUELDO', 16, 'bold', [50, 150, 50]);
            
            Object.entries(systemAnalysis.codeExamples.sueldo).forEach(([title, code]) => {
                addCode(code, title);
            });
            
            updateProgress(90, 'Finalizando documento...');
            
            // CONCLUSIONES
            pdf.addPage();
            yPosition = 20;
            
            addText('CONCLUSIONES Y RECOMENDACIONES', 16, 'bold', [100, 50, 200]);
            
            addText('Fortalezas del Sistema:', 12, 'bold');
            addText('• Arquitectura modular y escalable', 10);
            addText('• Interfaz intuitiva con drag & drop', 10);
            addText('• Trazabilidad completa de productos', 10);
            addText('• Sistema de autenticación robusto', 10);
            addText('• Reportes y analytics integrados', 10);
            addText('• Generación automática de QR', 10);
            
            addText('Áreas de Mejora:', 12, 'bold');
            addText('• Implementar base de datos externa', 10);
            addText('• Agregar notificaciones push', 10);
            addText('• Optimizar para dispositivos móviles', 10);
            addText('• Implementar backup automático', 10);
            
            updateProgress(100, 'Documento generado exitosamente');
            
            // Guardar PDF
            const filename = `Documentacion_Sistemas_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(filename);
            
            setTimeout(() => {
                document.getElementById('progress').style.display = 'none';
                document.getElementById('status').textContent = 'Documento PDF generado y descargado exitosamente';
            }, 1000);
        }
    </script>
</body>
</html>): Guarda categorías",
                        "renderCategories(): Renderiza vista de categorías",
                        "selectCategory(): Selecciona categoría activa",
                        "showCategoryDetail(): Muestra productos de categoría",
                        "deleteProduct(): Elimina producto de categoría",
                        "getProductsFlat(): Compatibilidad con QR"
                    ]
                },
                
                "generar-qr.html": {
                    purpose: "Generación de códigos QR para productos",
                    functions: [
                        "loadProducts(): Carga productos para select",
                        "updatePreview(): Actualiza vista previa",
                        "generateInternalCode(): Genera código interno",
                        "generateQR(): Genera código QR visual",
                        "downloadQR(): Descarga QR con información"
                    ]
                },
                
                "reportes.html": {
                    purpose: "Sistema de reportes y estadísticas",
                    functions: [
                        "ReportsAnalytics.init(): Inicializa sistema",
                        "getFilteredData(): Filtra datos por criterios",
                        "generateStats(): Genera estadísticas generales",
                        "createMovementsChart(): Gráfico de movimientos",
                        "createPlantsChart(): Gráfico por plantas",
                        "createProductsChart(): Productos más usados",
                        "createRejectionsChart(): Análisis de rechazos",
                        "loadDetailedReports(): Carga tablas detalladas",
                        "exportToCSV(): Exporta datos a CSV",
                        "applyFilters(): Aplica filtros seleccionados"
                    ]
                },
                
                "reports-analytics.js": {
                    purpose: "Motor de análisis y generación de reportes",
                    functions: [
                        "ReportsAnalytics(): Constructor principal",
                        "setDefaultDates(): Establece fechas por defecto",
                        "updateDateInputs(): Actualiza inputs de fecha",
                        "getActivePlants(): Cuenta plantas activas",
                        "formatLocation(): Formatea nombres de ubicación",
                        "downloadFile(): Descarga archivos generados"
                    ]
                }
            },
            
            sueldoFiles: {
                "index.html": {
                    purpose: "Página principal del sistema de sueldos",
                    functions: [
                        "Navegación entre módulos de sueldo",
                        "Acceso a calculadoras y reportes",
                        "Interfaz principal de usuario"
                    ]
                },
                
                "calcular-sueldo.html": {
                    purpose: "Calculadora principal de sueldos",
                    functions: [
                        "calculateSalary(): Cálculo de sueldo base",
                        "calculateOvertime(): Cálculo de horas extra",
                        "calculateDeductions(): Cálculo de descuentos",
                        "generatePayslip(): Generación de recibo de sueldo",
                        "saveEmployee(): Guardar datos de empleado",
                        "loadEmployees(): Cargar lista de empleados",
                        "exportToPDF(): Exportar recibo a PDF",
                        "calculateTaxes(): Cálculo de impuestos",
                        "calculateBenefits(): Cálculo de beneficios"
                    ]
                },
                
                "asistencia.html": {
                    purpose: "Control de asistencia y horarios",
                    functions: [
                        "markAttendance(): Marcar asistencia",
                        "calculateHours(): Cálculo de horas trabajadas",
                        "generateAttendanceReport(): Reporte de asistencia",
                        "trackBreaks(): Control de descansos",
                        "validateSchedule(): Validación de horarios",
                        "exportAttendance(): Exportar datos de asistencia"
                    ]
                },
                
                "reportes-sueldo.html": {
                    purpose: "Generación de reportes laborales",
                    functions: [
                        "generateMonthlyReport(): Reporte mensual",
                        "generateYearlyReport(): Reporte anual",
                        "calculateTotals(): Cálculo de totales",
                        "exportReports(): Exportación de reportes",
                        "filterByPeriod(): Filtrado por período",
                        "generateCharts(): Gráficos estadísticos"
                    ]
                }
            },
            
            dataFlow: {
                title: "Flujo de Datos del Sistema",
                steps: [
                    "1. Usuario se autentica (login.html + auth.js)",
                    "2. Navegación principal (stockeando.html)",
                    "3. Gestión de productos (productos.html)",
                    "4. Control de inventario (inventario.html + plant-manager.js)",
                    "5. Registro de movimientos (product-state-manager.js)",
                    "6. Visualización de historial (movimientos.html)",
                    "7. Generación de reportes (reportes.html + reports-analytics.js)",
                    "8. Códigos QR (generar-qr.html)"
                ]
            },
            
            stockeandoFeatures: [
                "Autenticación multi-usuario (admin, admin1, admin2)",
                "Gestión visual drag & drop",
                "Seguimiento completo de productos",
                "Generación automática de códigos únicos",
                "Códigos QR con información completa",
                "QR especiales para productos rechazados",
                "Reportes estadísticos con gráficos",
                "Exportación de datos (CSV, PDF)",
                "Trazabilidad por usuario",
                "Gestión de plantas y máquinas",
                "Sistema de rechazos con motivos",
                "Almacenamiento local persistente"
            ],
            
            sueldoFeatures: [
                "Cálculo automático de sueldos",
                "Control de asistencia en tiempo real",
                "Gestión de horas extra y descuentos",
                "Generación de recibos de sueldo",
                "Reportes mensuales y anuales",
                "Cálculo de impuestos y beneficios",
                "Exportación a PDF",
                "Base de datos de empleados",
                "Validación de horarios",
                "Gráficos estadísticos",
                "Historial de pagos",
                "Interface responsive"
            ]
        };

        function updateProgress(percent, message) {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('status').textContent = message;
        }

        function generateDocumentation() {
            updateProgress(10, 'Inicializando generación...');
            
            setTimeout(() => {
                const doc = new jsPDF();
                let yPosition = 20;
                
                // Función para agregar texto con salto de página automático
                function addText(text, fontSize = 12, isBold = false) {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(fontSize);
                    if (isBold) {
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFont(undefined, 'normal');
                    }
                    
                    const lines = doc.splitTextToSize(text, 170);
                    doc.text(lines, 20, yPosition);
                    yPosition += lines.length * (fontSize * 0.4) + 5;
                }
                
                function addSection(title, content) {
                    addText(title, 16, true);
                    yPosition += 5;
                    addText(content, 12);
                    yPosition += 10;
                }
                
                updateProgress(20, 'Generando portada...');
                
                // Portada
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('SISTEMA STOCKEANDO', 20, 30);
                doc.setFontSize(18);
                doc.text('Documentación Técnica Completa', 20, 45);
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text('Análisis de Código y Funcionalidades', 20, 60);
                doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')}`, 20, 75);
                
                yPosition = 100;
                
                updateProgress(30, 'Generando resumen ejecutivo...');
                
                // Resumen Ejecutivo
                addSection('RESUMEN EJECUTIVO', 
                    systemAnalysis.overview.description + '\n\n' +
                    'Arquitectura: ' + systemAnalysis.overview.architecture + '\n\n' +
                    'Tecnologías: ' + systemAnalysis.overview.technologies.join(', ')
                );
                
                updateProgress(40, 'Analizando funcionalidades clave...');
                
                // Funcionalidades Clave de ambos sistemas
                addText('FUNCIONALIDADES PRINCIPALES - STOCKEANDO', 16, true);
                yPosition += 5;
                systemAnalysis.stockeandoFeatures.forEach((feature, index) => {
                    addText(`${index + 1}. ${feature}`, 11);
                });
                yPosition += 10;
                
                addText('FUNCIONALIDADES PRINCIPALES - CALCULAR SUELDO', 16, true);
                yPosition += 5;
                systemAnalysis.sueldoFeatures.forEach((feature, index) => {
                    addText(`${index + 1}. ${feature}`, 11);
                });
                yPosition += 10;
                
                updateProgress(50, 'Documentando flujo de datos...');
                
                // Flujo de Datos
                addText('FLUJO DE DATOS DEL SISTEMA', 16, true);
                yPosition += 5;
                systemAnalysis.dataFlow.steps.forEach(step => {
                    addText(step, 11);
                });
                yPosition += 10;
                
                updateProgress(60, 'Analizando archivos del sistema...');
                
                // Análisis Sistema Stockeando
                addText('SISTEMA STOCKEANDO - ANÁLISIS DETALLADO', 16, true);
                yPosition += 5;
                addText(systemAnalysis.stockeandoSystem.description, 12);
                yPosition += 10;
                
                addText('Funcionalidades Stockeando:', 12, true);
                systemAnalysis.stockeandoFeatures.forEach(feature => {
                    addText(`• ${feature}`, 11);
                });
                yPosition += 10;
                
                addText('Archivos del Sistema Stockeando:', 14, true);
                Object.entries(systemAnalysis.stockeandoFiles).forEach(([filename, fileInfo]) => {
                    updateProgress(60 + (Object.keys(systemAnalysis.stockeandoFiles).indexOf(filename) * 15 / Object.keys(systemAnalysis.stockeandoFiles).length), 
                                 `Analizando Stockeando: ${filename}...`);
                    
                    addText(filename.toUpperCase(), 12, true);
                    addText(`Propósito: ${fileInfo.purpose}`, 11);
                    
                    if (fileInfo.functions) {
                        addText('Funciones:', 11, true);
                        fileInfo.functions.forEach(func => {
                            addText(`• ${func}`, 10);
                        });
                    }
                    yPosition += 8;
                });
                
                // Análisis Sistema Calcular Sueldo
                addText('SISTEMA CALCULAR SUELDO - ANÁLISIS DETALLADO', 16, true);
                yPosition += 5;
                addText(systemAnalysis.sueldoSystem.description, 12);
                yPosition += 10;
                
                addText('Funcionalidades Calcular Sueldo:', 12, true);
                systemAnalysis.sueldoFeatures.forEach(feature => {
                    addText(`• ${feature}`, 11);
                });
                yPosition += 10;
                
                addText('Archivos del Sistema Calcular Sueldo:', 14, true);
                Object.entries(systemAnalysis.sueldoFiles).forEach(([filename, fileInfo]) => {
                    updateProgress(75 + (Object.keys(systemAnalysis.sueldoFiles).indexOf(filename) * 15 / Object.keys(systemAnalysis.sueldoFiles).length), 
                                 `Analizando Sueldo: ${filename}...`);
                    
                    addText(filename.toUpperCase(), 12, true);
                    addText(`Propósito: ${fileInfo.purpose}`, 11);
                    
                    if (fileInfo.functions) {
                        addText('Funciones:', 11, true);
                        fileInfo.functions.forEach(func => {
                            addText(`• ${func}`, 10);
                        });
                    }
                    yPosition += 8;
                });
                
                updateProgress(90, 'Finalizando documento...');
                
                // Conclusiones
                addText('CONCLUSIONES TÉCNICAS', 16, true);
                yPosition += 5;
                addText(
                    'Los Sistemas de Utilidades representan una solución integral para la optimización empresarial. ' +
                    'Stockeando ofrece control total de inventario con trazabilidad completa, mientras que Calcular Sueldo ' +
                    'automatiza la gestión de nóminas. Ambos sistemas utilizan arquitectura modular, almacenamiento local ' +
                    'y interfaces responsivas. La combinación proporciona herramientas completas para la gestión operativa y administrativa.',
                    12
                );
                
                updateProgress(95, 'Guardando PDF...');
                
                // Guardar PDF
                doc.save('Utilidades_Documentacion_Tecnica_Completa.pdf');
                
                updateProgress(100, '¡Documentación generada exitosamente!');
                
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                    document.getElementById('status').textContent = 'Documentación completa de ambos sistemas descargada correctamente';
                }, 1000);
                
            }, 500);
        }
    </script>
</body>
</html>